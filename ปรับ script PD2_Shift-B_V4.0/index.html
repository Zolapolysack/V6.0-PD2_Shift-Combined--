<!DOCTYPE html>
<html lang="th" style="overflow-x:hidden;">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>ระบบบันทึกข้อมูลรายงานแผนกผลิต 2 - กะ B </title>
    <script src="https://cdn.tailwindcss.com/3.4.10"></script>
    <script src="../assets/js/i18n-translations.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@200;300;400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Prevent horizontal scroll */
        * { 
            max-width: 100vw; 
        }
        html, body {
            overflow-x: hidden !important;
            width: 100%;
            position: relative;
        }
        /* Success Modal Animations */
        @keyframes slideInDown {
            from {
                transform: translateY(-100px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        @keyframes scaleIn {
            from {
                transform: scale(0);
                opacity: 0;
            }
            to {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* mobile override: prevent narrow columns and clipping on iOS */
        @media (max-width: 640px) {
            body { background-attachment: scroll !important; }
            .glass-strong, .glass, .data-set { max-width: 100% !important; margin-left: 8px !important; margin-right: 8px !important; box-sizing: border-box !important; }
        }
        * {
            font-family: 'Kanit', sans-serif;
            font-feature-settings: "liga" 1, "kern" 1;
            text-rendering: optimizeLegibility;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        body {
            font-size: 16px;
            line-height: 1.6;
            letter-spacing: 0.01em;
            font-weight: 400;
            color: #f0f4f8; /* Light color for dark background */
        }
        
        body {
            background: linear-gradient(135deg, #000000 0%, #088fd7 100%);
            min-height: 100vh;
            font-feature-settings: "liga" 1;
            text-rendering: optimizeLegibility;
        }
        
        .glass {
            /* กลมกลืนกับพื้นหลังหลัก แต่ปรับให้ไม่เข้มเกินไปเป็นค่าเริ่มต้น */
            background:
                linear-gradient(135deg, rgba(0,0,0,0.32) 0%, rgba(8,143,215,0.08) 100%),
                linear-gradient(135deg, #000000 0%, #088fd7 100%);
            background-blend-mode: overlay;
            backdrop-filter: blur(10px) saturate(110%);
            -webkit-backdrop-filter: blur(10px) saturate(110%);
            border: 1px solid rgba(8,143,215,0.10);
            color: #e6f9ff;
            border-radius: 0.5rem;
            box-shadow: 0 8px 24px rgba(2,6,23,0.22);
            transition: background 180ms ease, box-shadow 180ms ease, transform 120ms ease;
        }

        /* เล็กน้อยเมื่อโฟกัส / โฮเวอร์ ให้ดูมีมิติแต่ไม่ฉูดฉาด */
        .glass:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 32px rgba(2,6,23,0.26);
        }

        /* ต่ำกว่าบนหน้า: ปรับให้กล่องที่อยู่ด้านล่าง (เช่น Quick Actions / Action Buttons)
           พื้นหลังเบากว่าและแสงน้อยลง เพื่อไม่ให้ดูเข้มจนเกินไป */
        .glass.mx-4.my-6,
        .glass.mx-4.my-6.p-6 {
            background:
                radial-gradient(circle at 10% 10%, rgba(255,255,255,0.06), transparent 18%),
                linear-gradient(135deg, rgba(255,255,255,0.03) 0%, rgba(8,143,215,0.04) 40%, rgba(2,6,23,0.16) 100%),
                linear-gradient(135deg, rgba(4,20,26,0.36) 0%, rgba(8,143,215,0.06) 100%);
            background-blend-mode: overlay, overlay, multiply;
            border: 1px solid rgba(8,143,215,0.06);
            box-shadow: 0 6px 14px rgba(2,6,23,0.12);
            color: #f1fbff; /* สว่างขึ้นเล็กน้อยแต่ยังคอนทราสต์กับพื้นมืด */
        }

        /* ถ้าต้องการเฉพาะสองกล่องนั้นแบบแม่นยำ ให้เพิ่มคลาส .soft ที่ HTML:
           <div class="glass soft ..."> ... </div>
           แล้วใช้ selector นี้แทนตัวบน */
        .glass.soft {
            background:
                linear-gradient(135deg, rgba(0,0,0,0.16) 0%, rgba(8,143,215,0.03) 100%),
                linear-gradient(135deg, #413d3d63 0%, #088fd7 100%);
            border: 1px solid rgba(8,143,215,0.05);
            box-shadow: 0 5px 12px rgba(2,6,23,0.10);
            color: #f6feff;
        }
        
        .glass-strong {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .glass-light {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Remove embossed / raised visual effects for accessibility and flat look */
        label.block.font-medium.mb-2.text-base,
        label.block.font-medium.mb-2.text-base * {
            transform: none !important;
            box-shadow: none !important;
        }
        /* Improve label clarity: stronger weight, precise spacing, high contrast */
        label.block.font-medium.mb-2.text-base {
            color: #ffffff !important;
            font-weight: 600 !important; /* semibold for better legibility */
            letter-spacing: 0.005em !important;
        }

        /* Neutralize glass shadows while keeping rounded corners */
        .glass, .glass-strong, .glass-light {
            box-shadow: none !important;
            border-radius: 0.5rem;
        }
        
        .btn-glow, .button-glow {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .btn-glow:hover, .button-glow:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }
        
        .btn-glow::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s;
        }
        
        .btn-glow:hover::before {
            left: 100%;
        }
        

        
        .btn-green { 
            background: linear-gradient(135deg, #16a34a, #22c55e);
            border: 2px solid #15803d;
        }
        .btn-green:hover { 
            background: linear-gradient(135deg, #15803d, #16a34a);
            box-shadow: 0 0 30px rgba(22, 197, 94, 0.6), 0 0 60px rgba(34, 197, 94, 0.3);
            border-color: #22c55e;
        }
        
        .btn-orange { 
            background: linear-gradient(135deg, #ea580c, #f97316);
            border: 2px solid #c2410c;
        }
        .btn-orange:hover { 
            background: linear-gradient(135deg, #c2410c, #ea580c);
            box-shadow: 0 0 30px rgba(234, 88, 12, 0.6), 0 0 60px rgba(249, 115, 22, 0.3);
            border-color: #f97316;
        }
        
        .btn-blue { 
            background: linear-gradient(135deg, #2563eb, #3b82f6);
            border: 2px solid #1d4ed8;
        }
        .btn-blue:hover { 
            background: linear-gradient(135deg, #1d4ed8, #2563eb);
            box-shadow: 0 0 30px rgba(37, 99, 235, 0.6), 0 0 60px rgba(59, 130, 246, 0.3);
            border-color: #3b82f6;
        }
        
        .btn-red { 
            background: linear-gradient(135deg, #dc2626, #ef4444);
            border: 2px solid #b91c1c;
        }
        .btn-red:hover { 
            background: linear-gradient(135deg, #b91c1c, #dc2626);
            box-shadow: 0 0 30px rgba(220, 38, 38, 0.6), 0 0 60px rgba(239, 68, 68, 0.3);
            border-color: #ef4444;
        }
        
        .btn-purple { 
            background: linear-gradient(135deg, #7c3aed, #8b5cf6);
            border: 2px solid #6d28d9;
        }
        .btn-purple:hover { 
            background: linear-gradient(135deg, #6d28d9, #7c3aed);
            box-shadow: 0 0 30px rgba(124, 58, 237, 0.6), 0 0 60px rgba(139, 92, 246, 0.3);
            border-color: #8b5cf6;
        }
        
        .input-field {
            transition: all 0.3s ease;
            font-size: 15px !important;
            font-weight: 400 !important;
            color: #04121a !important; /* stronger, high-contrast text */
            letter-spacing: 0.01em;
            line-height: 1.4;
            border-width: 1px;
            background: #ffffff !important;
            border-color: #d1d5db !important;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .input-field:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 2px rgba(0, 0, 0, 0.05);
            border-color: #3b82f6;
            outline: none;
            background: #ffffff !important;
            color: #04121a !important;
        }

        .readonly-field {
            background: #d1d5db !important;
            color: #04121a !important; /* ensure readonly text is high contrast */
            cursor: not-allowed;
            font-weight: 300 !important;
            font-size: 15px !important;
            border-color: #9ca3af !important;
            letter-spacing: 0.01em;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1) !important;
        }

    /* Placeholder + suggestion panel */
    .input-field::placeholder { color: #6b7280; opacity: 1; }
    /* Wage numeric style */
    .wage-a-input.valid { color: #ef4444 !important; font-weight: 700 !important; }
        .instant-suggestions, .instant-suggest { color: #04121a; background: #fff; border: 1px solid #d1d5db; border-radius: 6px; box-shadow: 0 8px 20px rgba(2,6,23,0.12); }
        .instant-suggestions div, .instant-suggest div { color: #04121a; }
        .instant-suggestions div:hover, .instant-suggest div:hover { background: #eff6ff; }
        
        .data-set {
            animation: slideIn 0.5s ease-out;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid #ffffff;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Error field styling */
        .error-field {
            border: 2px solid #f30000 !important;
            background: #fef2f2 !important;
            will-change: transform;
        }
        
        .error-field.shake-animation {
            animation: shake 0.4s ease-in-out;
        }
        
        .error-field:focus {
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2) !important;
            border-color: #dc2626 !important;
        }
        
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }
        
        .progress-step {
            transition: all 0.3s ease;
        }
        
        .progress-step.active {
            background: #16a34a;
            color: white;
        }
        
        .progress-step.completed {
            background: #059669;
            color: white;
        }
        
        .notification {
            animation: slideInRight 0.3s ease-out;
        }
        
        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .modal-backdrop {
            backdrop-filter: blur(5px);
            background: rgba(0, 0, 0, 0.5);
        }
        
        @media (max-width: 768px) {
            .input-field {
                font-size: 16px !important;
            }
            
            .btn-glow, .button-glow {
                min-height: 44px;
            }
        }
    </style>
    <!-- LEGACY / OLD MOBILE SUPPORT START -->
    <style>
        /* Fallback พื้นหลัง (ถ้า gradient ไม่ทำงานจะยังเห็นสีหลัก) */
        body { background-color:#1e40af; }
        /* เมื่อไม่รองรับ backdrop-filter ให้ใช้พื้นหลังขาวโปร่งหนาแทน เพื่อให้อ่านง่ายบน iOS <12 / Android เก่า */
        .no-backdrop .glass,
        .no-backdrop .glass-strong,
        .no-backdrop .glass-light { 
            backdrop-filter:none !important; 
            -webkit-backdrop-filter:none !important; 
            background:rgba(255,255,255,0.88) !important; 
            border-color:rgba(0,0,0,0.08) !important;
        }
        /* ===== ANIMATIONS & TRANSITIONS ===== */
        .btn-glow:hover, .button-glow:hover { transform:none !important; box-shadow:none !important; }
    </style>
    <script>
        /* Feature / capability detection + polyfills loader สำหรับเบราว์เซอร์เก่า */
        (function(){
            var docEl = document.documentElement;
            try {
                if(!(window.CSS && CSS.supports && CSS.supports('backdrop-filter: blur(4px)'))){
                    docEl.classList.add('no-backdrop');
                }
            } catch(e){ docEl.classList.add('no-backdrop'); }

            // Polyfill: Promise
            if(typeof Promise === 'undefined'){
                var p = document.createElement('script');
                p.src = 'https://cdn.jsdelivr.net/npm/promise-polyfill@8/dist/polyfill.min.js';
                document.head.appendChild(p);
            }
            // Polyfill: fetch
            if(typeof fetch === 'undefined'){
                var f = document.createElement('script');
                f.src = 'https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.20/dist/fetch.umd.min.js';
                document.head.appendChild(f);
            }
            // Polyfill: IntersectionObserver (ใช้บางกรณีหากมีการเพิ่มภายหลัง)
            if(!('IntersectionObserver' in window)){
                var io = document.createElement('script');
                io.src = 'https://cdn.jsdelivr.net/npm/intersection-observer@0.12.2/intersection-observer.js';
                document.head.appendChild(io);
            }
            // NodeList.forEach บน IE / เก่ามาก (กันไว้เผื่อเปิดผ่าน WebView เก่า)
            if(window.NodeList && !NodeList.prototype.forEach){
                NodeList.prototype.forEach = Array.prototype.forEach;
            }
            // classList บาง WebView เก่าขาด (ตรวจผิวเผิน)
            if(!('classList' in document.createElement('_'))){
                try { (document.createElement('script').src='https://unpkg.com/classlist-polyfill@1.2.0/src/index.js'); } catch(e){}
            }
        })();
    </script>
    <!-- LEGACY / OLD MOBILE SUPPORT END -->
</head>
<!-- mobile responsive fix: add bottom safe-area padding for Android navbar avoidance -->
<body class="min-h-screen pb-[env(safe-area-inset-bottom,0)]" style="overflow-x:hidden;">
    <!-- Header Section -->
    <div class="glass-strong rounded-lg mx-4 mt-4 p-6 mb-6 relative">
        <!-- Back to Home Button (Mobile-First Navigation) -->
        <a href="../index.html" class="absolute top-4 left-4 flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-rose-500 to-red-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105 z-10">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/>
            </svg>
            <span class="font-medium" data-i18n="nav.back">กลับหน้าหลัก</span>
        </a>
        
        <!-- Language Selector Button (Top Right) -->
        <div class="absolute top-4 right-4 z-10">
            <button onclick="toggleLanguageMenu()" class="flex items-center gap-2 px-3 py-2 bg-gradient-to-r from-blue-500 to-indigo-600 text-white rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 hover:scale-105">
                <span class="font-medium" id="currentLanguage">ไทย</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </button>
            
            <!-- Language Dropdown Menu -->
            <div id="languageMenu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-xl z-20 max-h-64 overflow-y-auto">
                <button onclick="changeLanguage('th')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors border-b">
                    <span class="font-medium text-gray-700">ภาษาไทย</span>
                </button>
                <button onclick="changeLanguage('en')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors border-b">
                    <span class="font-medium text-gray-700">English</span>
                </button>
                <button onclick="changeLanguage('my')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors border-b">
                    <span class="font-medium text-gray-700">မြန်မာ</span>
                </button>
                <button onclick="changeLanguage('mnw')" class="w-full px-4 py-3 text-left hover:bg-blue-50 transition-colors">
                    <span class="font-medium text-gray-700">မန်</span>
                </button>
            </div>
        </div>
        
        <div class="text-center mb-4 pt-12">
            <h1 class="text-3xl font-medium text-gray-800 tracking-normal leading-relaxed" data-i18n="system.title">ระบบบันทึกข้อมูลรายงานแผนกผลิต 2</h1>
            <div class="w-16 h-0.5 bg-gray-400 mx-auto mt-3"></div>
        </div>
        
        <!-- Status Bar -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 bg-white rounded-lg p-4">
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="statusGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#statusGrad)" cx="12" cy="12" r="10"/>
                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                </svg>
                <span class="font-normal text-gray-700 text-sm md:text-base" data-i18n="status.ready">สถานะ: พร้อมใช้งาน</span>
            </div>
            
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="shiftGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#shiftGrad)" cx="12" cy="12" r="5"/>
                    <line stroke="white" stroke-width="2" x1="12" y1="1" x2="12" y2="3"/>
                    <line stroke="white" stroke-width="2" x1="12" y1="21" x2="12" y2="23"/>
                    <line stroke="white" stroke-width="2" x1="4.22" y1="4.22" x2="5.64" y2="5.64"/>
                    <line stroke="white" stroke-width="2" x1="18.36" y1="18.36" x2="19.78" y2="19.78"/>
                    <line stroke="white" stroke-width="2" x1="1" y1="12" x2="3" y2="12"/>
                    <line stroke="white" stroke-width="2" x1="21" y1="12" x2="23" y2="12"/>
                    <line stroke="white" stroke-width="2" x1="4.22" y1="19.78" x2="5.64" y2="18.36"/>
                    <line stroke="white" stroke-width="2" x1="18.36" y1="5.64" x2="19.78" y2="4.22"/>
                </svg>
                <span class="font-normal text-gray-700 text-sm md:text-base" data-i18n="shift.b">สำหรับ กะ B (20:00-08:00 น.)</span>
            </div>
            
            <div class="flex items-center">
                <svg class="w-6 h-6 mr-2 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="timeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <circle fill="url(#timeGrad)" cx="12" cy="12" r="10"/>
                    <polyline stroke="white" stroke-width="2" points="12,6 12,12 16,14"/>
                </svg>
                <span class="font-normal text-gray-700 text-sm md:text-base" id="currentTime"></span>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    <div class="glass rounded-lg mx-4 mb-6 p-6">
        <div class="flex justify-center">
            <div class="flex items-center bg-white rounded-lg px-4 py-2">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="dataGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#8b5cf6;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <rect fill="url(#dataGrad)" x="3" y="4" width="18" height="18" rx="2" ry="2"/>
                    <line stroke="white" stroke-width="2" x1="16" y1="2" x2="16" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="8" y1="2" x2="8" y2="6"/>
                    <line stroke="white" stroke-width="2" x1="3" y1="10" x2="21" y2="10"/>
                </svg>
                <span class="font-normal text-gray-700 text-base" style="color:#000000;">จำนวนชุดข้อมูล: <span id="dataSetCount" class="text-blue-600 font-medium" style="color:#ff0000;">1</span>/100</span>
            </div>
        </div>
    </div>

    <!-- Data Entry Container -->
    <div id="dataContainer" class="mx-4 space-y-6">
        <!-- Data sets will be generated here -->
    </div>

    <!-- Quick Actions Box -->
    <div class="glass rounded-lg mx-4 my-6 p-6 w-full max-w-full">
        <h3 class="text-white text-lg font-semibold mb-4 text-center"></h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 w-full">
            <button onclick="addDataSet()" class="btn-glow btn-green text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-4v4h-2v-4H7v-2h4V7h2v4h4v2z"/>
                </svg>
                <span>เพิ่มชุดข้อมูลใหม่</span>
            </button>
            <button onclick="copyAndAddDataSet()" class="btn-glow btn-blue text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/>
                </svg>
                <span>คัดลอกโดยเพิ่มชุดข้อมูล</span>
            </button>
            <button onclick="resetToSingleDataSet()" class="btn-glow btn-red text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 5V2L8 6l4 4V7c2.757 0 5 2.243 5 5a5 5 0 0 1-5 5c-2.05 0-3.813-1.232-4.58-3H5.35c.84 3.45 3.95 6 7.65 6 4.418 0 8-3.582 8-8s-3.582-8-8-8z"/>
                </svg>
                <span>รีเซ็ตการบันทึกข้อมูล</span>
            </button>
            <button onclick="exportPNG()" class="btn-glow text-white px-5 py-4 rounded-xl font-medium text-base flex items-center justify-center gap-2 w-full hover:scale-105 transition-transform" style="background: linear-gradient(135deg, #f50494, #c0037a);">
                <svg class="w-6 h-6" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M21 19V5a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2zM8.5 13.5l2 2.5 3-4 4.5 6H6l2.5-4.5z"/>
                </svg>
                <span>บันทึกเป็นรูปภาพ</span>
            </button>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="glass rounded-lg mx-4 my-6 p-6 w-full max-w-full">
        <h3 class="text-white text-lg font-semibold mb-4 text-center"></h3>
        <div class="flex justify-center">
            <button onclick="submitData()" class="btn-glow btn-orange text-white px-8 py-5 rounded-xl font-semibold text-lg flex items-center justify-center gap-3 w-full sm:w-auto min-w-[280px] hover:scale-105 transition-transform shadow-xl">
                <svg class="w-7 h-7" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                </svg>
                <span>บันทึกข้อมูลทั้งหมด</span>
            </button>
        </div>
    </div>

    <!-- Modals -->
    <!-- Success Modal with Auto-Reset -->
    <div id="successModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4" style="background-color: rgba(0, 0, 0, 0.7);">
        <div class="glass-strong rounded-2xl w-full sm:max-w-2xl p-10 shadow-2xl" style="animation: slideInDown 0.3s ease-out;">
            <div class="text-center mb-8">
                <div class="mx-auto w-24 h-24 bg-gradient-to-br from-green-400 to-green-600 rounded-full flex items-center justify-center mb-5" style="animation: scaleIn 0.5s ease-out;">
                    <svg class="w-14 h-14 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"/>
                    </svg>
                </div>
                <h3 class="text-3xl font-bold text-gray-800 mb-3">บันทึกข้อมูลสำเร็จ</h3>
                <p class="text-gray-600 text-xl"><span id="successModalCount" class="font-bold text-green-600 text-2xl">0</span> รายการ ถูกบันทึกเรียบร้อย</p>
            </div>
            
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-6 mb-8 border-2 border-blue-200">
                <p class="text-gray-700 font-semibold text-center mb-3 text-lg">คุณต้องการทำอะไรต่อ?</p>
                <div class="text-center">
                    <p class="text-base text-gray-600">จะกรอกข้อมูลต่ออัตโนมัติใน <span id="countdownTimer" class="font-bold text-3xl text-blue-600">90</span> วินาที...</p>
                </div>
            </div>
            
            <div class="flex flex-col sm:flex-row gap-4">
                <button onclick="continueWithSameEmployee()" class="flex-1 bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white px-8 py-5 rounded-xl font-semibold text-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 text-center">
                    <div class="leading-tight">
                        <div class="text-xl mb-1">กรอกข้อมูลต่อ</div>
                        <div class="text-sm opacity-90">(พนักงานคนเดียวกัน)</div>
                    </div>
                </button>
                <button onclick="resetForNextEmployee()" class="flex-1 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white px-8 py-5 rounded-xl font-semibold text-lg transition-all duration-200 shadow-lg hover:shadow-xl transform hover:scale-105 text-center">
                    <div class="leading-tight">
                        <div class="text-xl mb-1">เริ่มใหม่</div>
                        <div class="text-sm opacity-90">(พนักงานคนถัดไป)</div>
                    </div>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Machine Modal -->
    <div id="machineModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="machineGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#7c3aed;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#5b21b6;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#machineGrad)" x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                        <line stroke="white" stroke-width="2" x1="8" y1="21" x2="16" y2="21"/>
                        <line stroke="white" stroke-width="2" x1="12" y1="17" x2="12" y2="21"/>
                    </svg>
                    เพิ่มเครื่องทอใหม่
                </h3>
                <button onclick="closeModal('machine')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newMachine" placeholder="เช่น CL96" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('machine')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    บันทึก
                </button>
                <button onclick="closeModal('machine')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Employee Modal -->
    <div id="employeeModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="employeeGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#059669;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#047857;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <path fill="url(#employeeGrad)" d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
                    </svg>
                    เพิ่มพนักงานใหม่
                </h3>
                <button onclick="closeModal('employee')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newEmployeeId" placeholder="รหัสพนักงาน เช่น ZP99999" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-3">
            <input type="text" id="newEmployeeName" placeholder="ชื่อ-นามสกุล" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('employee')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    บันทึก
                </button>
                <button onclick="closeModal('employee')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Fabric Size Modal -->
    <div id="fabricModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800 flex items-center">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <defs>
                            <linearGradient id="fabricGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#dc2626;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#b91c1c;stop-opacity:1" />
                            </linearGradient>
                        </defs>
                        <rect fill="url(#fabricGrad)" x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                        <path stroke="white" stroke-width="2" d="m9 9 3 3-3 3m6-6h-6"/>
                    </svg>
                    เพิ่มขนาดหน้าผ้าใหม่
                </h3>
                <button onclick="closeModal('fabric')" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                    </svg>
                </button>
            </div>
            <input type="text" id="newFabricSize" placeholder="เช่น 2025800SMN" class="input-field w-full p-3 border border-gray-300 rounded-lg mb-4">
            <div class="flex gap-3">
                <button onclick="saveModalData('fabric')" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    บันทึก
                </button>
                <button onclick="closeModal('fabric')" class="btn-glow bg-gray-500 text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center">
        <div class="glass-strong rounded-lg p-6 w-full sm:max-w-sm mx-4">
            <div class="text-center space-y-4">
                <div class="mx-auto w-14 h-14 relative">
                    <div class="pd2-spinner" aria-hidden="true"></div>
                    <div class="sr-only" role="status">กำลังบันทึก</div>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">กำลังบันทึกข้อมูล</h3>
                <p class="text-gray-600 mb-4" id="loadingStatus">กำลังเตรียมข้อมูล...</p>
                
                <!-- Progress Steps -->
                <div class="flex justify-between mb-4">
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step1">1</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step2">2</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step3">3</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step4">4</div>
                    <div class="progress-step w-8 h-8 rounded-full bg-gray-300 flex items-center justify-center text-sm font-bold" id="step5">5</div>
                </div>

                <style>
                @keyframes pd2Spin { to { transform: rotate(360deg); } }
                .pd2-spinner { width:100%; height:100%; box-sizing:border-box; border:3px solid rgba(0,0,0,0.07); border-top-color:var(--color-accent,#10b981); border-radius:50%; animation: pd2Spin .8s linear infinite; }
                </style>
                
                <div class="text-sm text-gray-500">
                    <div>1. เตรียมข้อมูล</div>
                    <div>2. ตรวจสอบข้อมูล</div>
                    <div>3. เชื่อมต่อเซิร์ฟเวอร์</div>
                    <div>4. ส่งข้อมูล</div>
                    <div>5. ยืนยันการบันทึก</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notifications -->
    <div id="notifications" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Recovery Modal -->
    <div id="recoveryModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
    <div class="glass-strong rounded-lg w-full sm:max-w-md p-6">
            <div class="flex items-center mb-4">
                <svg class="w-8 h-8 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <defs>
                        <linearGradient id="recoveryGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                            <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                            <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                        </linearGradient>
                    </defs>
                    <path fill="url(#recoveryGrad)" d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>
                </svg>
                <h3 class="text-xl font-bold text-gray-800">พบข้อมูลค้างส่ง</h3>
            </div>
            <p class="text-gray-600 mb-6">พบข้อมูลที่ยังไม่ได้ส่งจากครั้งก่อน คุณต้องการลองส่งใหม่หรือไม่?</p>
            <div class="flex gap-3">
                <button onclick="retryPendingSubmission()" class="btn-glow btn-green text-white px-6 py-2 rounded-lg font-semibold flex-1">
                    ลองส่งใหม่
                </button>
                <button onclick="discardPendingSubmission()" class="btn-glow btn-red text-white px-6 py-2 rounded-lg font-semibold">
                    ยกเลิก
                </button>
            </div>
        </div>
    </div>

    <!-- Removed usage instructions and 4 feature cards per request -->
    <!-- (previously: <div class="glass-light rounded-lg mx-4 mb-6 p-6"> ... </div>) -->

    <script>
        // Debug badge overlay (non-invasive) — disabled by default
        var PD2_DEBUG_ON = false;
        try {
            const qs = new URLSearchParams(window.location.search);
            PD2_DEBUG_ON = (qs.has('pd2debug') || qs.get('debug') === '1' || localStorage.getItem('PD2_DEBUG') === '1');
        } catch(_){}
        function PD2DebugBadge(msg) {
            if (!PD2_DEBUG_ON) return;
            try {
                let badge = document.getElementById('pd2-debug-badge');
                if (!badge) {
                    badge = document.createElement('div');
                    badge.id = 'pd2-debug-badge';
                    Object.assign(badge.style, {
                        position: 'fixed', top: '8px', right: '8px', zIndex: 99999,
                        background: 'rgba(0,0,0,0.7)', color: '#fff', fontSize: '12px',
                        padding: '6px 10px', borderRadius: '8px', boxShadow: '0 2px 8px rgba(0,0,0,0.18)',
                        pointerEvents: 'none'
                    });
                    document.body.appendChild(badge);
                }
                badge.textContent = String(msg || '');
                badge.style.display = 'block';
                setTimeout(() => { if (badge) badge.style.display = 'none'; }, 2200);
            } catch(_){ }
        }

        // Master Data Arrays
        const machines = [
            "CL1","CL2","CL3","CL4","CL5","CL6","CL7","CL8","CL9","CL12","CL13","CL14",
            "CL15","CL16","CL17","CL19","CL25","CL26","CL27","CL28","CL29","CL30","CL31",
            "CL32","CL33","CL44","CL45","CL46","CL47","CL48","CL49","CL50","CL51","CL52",
            "CL53","CL54","CL55","CL56","CL57","CL58","CL59","CL60","CL61","CL62","CL63",
            "CL64","CL65","CL66","CL67","CL68","CL69","CL70","CL71","CL72","CL73","CL74",
            "CL75","CL76","CL77","CL78","CL79","CL80","CL81","CL82","CL83","CL84","CL85",
            "CL86","CL87","CL88","CL89","CL90","CL91","CL92","CL93","CL94","CL95",
            "CL34","CL35","CL36"
        ];

        // Combined machine list (ตามที่ผู้ใช้ร้องขอ)
        const combinedMachines = [
            "CL1 ตัดม้วนครั้งที่ 2", "CL2 ตัดม้วนครั้งที่ 2", "CL3 ตัดม้วนครั้งที่ 2", "CL4 ตัดม้วนครั้งที่ 2",
            "CL5 ตัดม้วนครั้งที่ 2", "CL6 ตัดม้วนครั้งที่ 2", "CL7 ตัดม้วนครั้งที่ 2", "CL8 ตัดม้วนครั้งที่ 2",
            "CL9 ตัดม้วนครั้งที่ 2", "CL12 ตัดม้วนครั้งที่ 2", "CL13 ตัดม้วนครั้งที่ 2", "CL14 ตัดม้วนครั้งที่ 2",
            "CL15 ตัดม้วนครั้งที่ 2", "CL16 ตัดม้วนครั้งที่ 2", "CL17 ตัดม้วนครั้งที่ 2", "CL19 ตัดม้วนครั้งที่ 2",
            "CL25 ตัดม้วนครั้งที่ 2", "CL26 ตัดม้วนครั้งที่ 2", "CL27 ตัดม้วนครั้งที่ 2", "CL28 ตัดม้วนครั้งที่ 2",
            "CL29 ตัดม้วนครั้งที่ 2", "CL30 ตัดม้วนครั้งที่ 2", "CL31 ตัดม้วนครั้งที่ 2", "CL32 ตัดม้วนครั้งที่ 2",
            "CL33 ตัดม้วนครั้งที่ 2", "CL44 ตัดม้วนครั้งที่ 2", "CL45 ตัดม้วนครั้งที่ 2", "CL46 ตัดม้วนครั้งที่ 2",
            "CL47 ตัดม้วนครั้งที่ 2", "CL48 ตัดม้วนครั้งที่ 2", "CL49 ตัดม้วนครั้งที่ 2", "CL50 ตัดม้วนครั้งที่ 2",
            "CL51 ตัดม้วนครั้งที่ 2", "CL52 ตัดม้วนครั้งที่ 2", "CL53 ตัดม้วนครั้งที่ 2", "CL54 ตัดม้วนครั้งที่ 2",
            "CL55 ตัดม้วนครั้งที่ 2", "CL56 ตัดม้วนครั้งที่ 2", "CL57 ตัดม้วนครั้งที่ 2", "CL58 ตัดม้วนครั้งที่ 2",
            "CL59 ตัดม้วนครั้งที่ 2", "CL60 ตัดม้วนครั้งที่ 2", "CL61 ตัดม้วนครั้งที่ 2", "CL62 ตัดม้วนครั้งที่ 2",
            "CL63 ตัดม้วนครั้งที่ 2", "CL64 ตัดม้วนครั้งที่ 2", "CL65 ตัดม้วนครั้งที่ 2", "CL66 ตัดม้วนครั้งที่ 2",
            "CL67 ตัดม้วนครั้งที่ 2", "CL68 ตัดม้วนครั้งที่ 2", "CL69 ตัดม้วนครั้งที่ 2", "CL70 ตัดม้วนครั้งที่ 2",
            "CL71 ตัดม้วนครั้งที่ 2", "CL72 ตัดม้วนครั้งที่ 2", "CL73 ตัดม้วนครั้งที่ 2", "CL74 ตัดม้วนครั้งที่ 2",
            "CL75 ตัดม้วนครั้งที่ 2", "CL76 ตัดม้วนครั้งที่ 2", "CL77 ตัดม้วนครั้งที่ 2", "CL78 ตัดม้วนครั้งที่ 2",
            "CL79 ตัดม้วนครั้งที่ 2", "CL80 ตัดม้วนครั้งที่ 2", "CL81 ตัดม้วนครั้งที่ 2", "CL82 ตัดม้วนครั้งที่ 2",
            "CL83 ตัดม้วนครั้งที่ 2", "CL84 ตัดม้วนครั้งที่ 2", "CL85 ตัดม้วนครั้งที่ 2", "CL86 ตัดม้วนครั้งที่ 2",
            "CL87 ตัดม้วนครั้งที่ 2", "CL88 ตัดม้วนครั้งที่ 2", "CL89 ตัดม้วนครั้งที่ 2", "CL90 ตัดม้วนครั้งที่ 2",
            "CL91 ตัดม้วนครั้งที่ 2", "CL92 ตัดม้วนครั้งที่ 2", "CL93 ตัดม้วนครั้งที่ 2", "CL94 ตัดม้วนครั้งที่ 2",
            "CL95 ตัดม้วนครั้งที่ 2", "CL34 ตัดม้วนครั้งที่ 2", "CL35 ตัดม้วนครั้งที่ 2", "CL36 ตัดม้วนครั้งที่ 2",
            "CL1 ตัดม้วนครั้งที่ 3", "CL2 ตัดม้วนครั้งที่ 3", "CL3 ตัดม้วนครั้งที่ 3", "CL4 ตัดม้วนครั้งที่ 3",
            "CL5 ตัดม้วนครั้งที่ 3", "CL6 ตัดม้วนครั้งที่ 3", "CL7 ตัดม้วนครั้งที่ 3", "CL8 ตัดม้วนครั้งที่ 3",
            "CL9 ตัดม้วนครั้งที่ 3", "CL12 ตัดม้วนครั้งที่ 3", "CL13 ตัดม้วนครั้งที่ 3", "CL14 ตัดม้วนครั้งที่ 3",
            "CL15 ตัดม้วนครั้งที่ 3", "CL16 ตัดม้วนครั้งที่ 3", "CL17 ตัดม้วนครั้งที่ 3", "CL19 ตัดม้วนครั้งที่ 3",
            "CL25 ตัดม้วนครั้งที่ 3", "CL26 ตัดม้วนครั้งที่ 3", "CL27 ตัดม้วนครั้งที่ 3", "CL28 ตัดม้วนครั้งที่ 3",
            "CL29 ตัดม้วนครั้งที่ 3", "CL30 ตัดม้วนครั้งที่ 3", "CL31 ตัดม้วนครั้งที่ 3", "CL32 ตัดม้วนครั้งที่ 3",
            "CL33 ตัดม้วนครั้งที่ 3", "CL44 ตัดม้วนครั้งที่ 3", "CL45 ตัดม้วนครั้งที่ 3", "CL46 ตัดม้วนครั้งที่ 3",
            "CL47 ตัดม้วนครั้งที่ 3", "CL48 ตัดม้วนครั้งที่ 3", "CL49 ตัดม้วนครั้งที่ 3", "CL50 ตัดม้วนครั้งที่ 3",
            "CL51 ตัดม้วนครั้งที่ 3", "CL52 ตัดม้วนครั้งที่ 3", "CL53 ตัดม้วนครั้งที่ 3", "CL54 ตัดม้วนครั้งที่ 3",
            "CL55 ตัดม้วนครั้งที่ 3", "CL56 ตัดม้วนครั้งที่ 3", "CL57 ตัดม้วนครั้งที่ 3", "CL58 ตัดม้วนครั้งที่ 3",
            "CL59 ตัดม้วนครั้งที่ 3", "CL60 ตัดม้วนครั้งที่ 3", "CL61 ตัดม้วนครั้งที่ 3", "CL62 ตัดม้วนครั้งที่ 3",
            "CL63 ตัดม้วนครั้งที่ 3", "CL64 ตัดม้วนครั้งที่ 3", "CL65 ตัดม้วนครั้งที่ 3", "CL66 ตัดม้วนครั้งที่ 3",
            "CL67 ตัดม้วนครั้งที่ 3", "CL68 ตัดม้วนครั้งที่ 3", "CL69 ตัดม้วนครั้งที่ 3", "CL70 ตัดม้วนครั้งที่ 3",
            "CL71 ตัดม้วนครั้งที่ 3", "CL72 ตัดม้วนครั้งที่ 3", "CL73 ตัดม้วนครั้งที่ 3", "CL74 ตัดม้วนครั้งที่ 3",
            "CL75 ตัดม้วนครั้งที่ 3", "CL76 ตัดม้วนครั้งที่ 3", "CL77 ตัดม้วนครั้งที่ 3", "CL78 ตัดม้วนครั้งที่ 3",
            "CL79 ตัดม้วนครั้งที่ 3", "CL80 ตัดม้วนครั้งที่ 3", "CL81 ตัดม้วนครั้งที่ 3", "CL82 ตัดม้วนครั้งที่ 3",
            "CL83 ตัดม้วนครั้งที่ 3", "CL84 ตัดม้วนครั้งที่ 3", "CL85 ตัดม้วนครั้งที่ 3", "CL86 ตัดม้วนครั้งที่ 3",
            "CL87 ตัดม้วนครั้งที่ 3", "CL88 ตัดม้วนครั้งที่ 3", "CL89 ตัดม้วนครั้งที่ 3", "CL90 ตัดม้วนครั้งที่ 3",
            "CL91 ตัดม้วนครั้งที่ 3", "CL92 ตัดม้วนครั้งที่ 3", "CL93 ตัดม้วนครั้งที่ 3", "CL94 ตัดม้วนครั้งที่ 3",
            "CL95 ตัดม้วนครั้งที่ 3", "CL34 ตัดม้วนครั้งที่ 3", "CL35 ตัดม้วนครั้งที่ 3", "CL36 ตัดม้วนครั้งที่ 3"
        ];

        machines.push(...combinedMachines);
        const preferredOrderBase = [
            "CL1","CL2","CL3","CL4","CL5","CL6","CL7","CL8","CL9","CL12","CL13","CL14",
            "CL15","CL16","CL17","CL19","CL25","CL26","CL27","CL28","CL29","CL30","CL31",
            "CL32","CL33","CL44","CL45","CL46","CL47","CL48","CL49","CL50","CL51","CL52",
            "CL53","CL54","CL55","CL56","CL57","CL58","CL59","CL60","CL61","CL62","CL63",
            "CL64","CL65","CL66","CL67","CL68","CL69","CL70","CL71","CL72","CL73","CL74",
            "CL75","CL76","CL77","CL78","CL79","CL80","CL81","CL82","CL83","CL84","CL85",
            "CL86","CL87","CL88","CL89","CL90","CL91","CL92","CL93","CL94","CL95",
            "CL34","CL35","CL36"
        ];
        const orderMap = new Map(preferredOrderBase.map((id, idx) => [parseInt(id.replace(/^CL/i, ''), 10), idx]));
        const phaseRank = (s) => {
            if (!s || typeof s !== 'string') return 0;
            // รูปแบบใหม่: "ครั้งที่ X" เท่านั้น
            const m = s.match(/ครั้งที่\s*(\d+)/);
            if (!m) return 0; // ปกติ
            const phase = parseInt(m[1], 10);
            if (phase === 2) return 1;
            if (phase === 3) return 2;
            return 0;
        };
        const machineComparator = (a, b) => {
            const pa = phaseRank(a);
            const pb = phaseRank(b);
            if (pa !== pb) return pa - pb;
            const nAraw = (a.match(/^CL(\d+)/i) || [])[1];
            const nBraw = (b.match(/^CL(\d+)/i) || [])[1];
            const idxA = nAraw ? (orderMap.get(parseInt(nAraw, 10)) ?? Number.MAX_SAFE_INTEGER) : Number.MAX_SAFE_INTEGER;
            const idxB = nBraw ? (orderMap.get(parseInt(nBraw, 10)) ?? Number.MAX_SAFE_INTEGER) : Number.MAX_SAFE_INTEGER;
            if (idxA !== idxB) return idxA - idxB;
            return a.localeCompare(b, 'th');
        };
        machines.sort(machineComparator);

        const employees = [
            { "id": "ZP91042", "name": "นาย วัน ชัย" },
            { "id": "ZP91385", "name": "นางสาว รัฐนันท์ นิธากรณ์" },
            { "id": "ZP92285", "name": "นายตาลซิน ออง" },
            { "id": "ZP91702", "name": "นาย พิว ไว จอ" },
            { "id": "ZP92237", "name": "ซอ พู ยา ซา" },
            { "id": "ZP92286", "name": "นางสาว ซิก เค่น" },
            { "id": "ZP92250", "name": "ยุน วา ติ" },
            { "id": "ZP91720", "name": "นางสาว จู จู ซาน" },
            { "id": "ZP92187", "name": "ติน โม แท็ค" },
            { "id": "ZP92282", "name": "ปาลามอน" },
            { "id": "ZP91922", "name": "นาย เพีย โซ อู" },
            { "id": "ZP92434", "name": "น.ส.ลำไย ใจชื่อ" },
            { "id": "ZP92471", "name": "นางมอว มอว วิน" },
            { "id": "ZP91512", "name": "นาง นัน มา เล ยี" },
            { "id": "ZP92321", "name": "น.ส.มะซูซูเย" },
            { "id": "ZP92491", "name": "นางมา ทาซิน มน" },
            { "id": "ZP91680", "name": "นาง ติน ซุย" },
            { "id": "ZP9499", "name": "นาง จำรัศ พุทธา" },
            { "id": "ZP91569", "name": "นาย วัชชระ ชะฎาดำ" },
            { "id": "ZP92350", "name": "นางสาว ซินมาลวิน" },
            { "id": "ZP91719", "name": "นาย พี พิว ออง" },
            { "id": "ZP9060", "name": "นางสาว อังคณา บุญธรรม" },
            { "id": "ZP92495", "name": "นางพรสวรรค์" },
            { "id": "ZP9174", "name": "นาง รัดดา ศรีทอง" },
            { "id": "ZP92186", "name": "ซามินอู" },
            { "id": "ZP92317", "name": "นาย ยาน ลิน ออง" },
            { "id": "ZP92402", "name": "นาย ลา วิน" },
            { "id": "ZP91718", "name": "นาย หม่อง ซอ" },
            { "id": "ZP92425", "name": "น.ส.วิ" },
            { "id": "ZP92318", "name": "น.ส.คินวิน" },
            { "id": "ZP91617", "name": "นาง พิไลพรรณ เตโช" },
            { "id": "ZP92481", "name": "นางสาว ติ่น ซา" },
            { "id": "ZP92390", "name": "นางสาว เอ วิน" },
            { "id": "ZP92107", "name": "นาง จี ปิยประภากุล" }
        ];

        const fabricSizes = [
            // Merged old + new (updated 2025-09-17). Rule: sort by first two leading digits ascending; entries that are not purely 2 starting digits (contain letter in first 2 chars or start with letter) placed at end.
            "1425800",
            "1621720SMFX",
            "1625800",
            "1625800SM",
            "1725800",
            "1825800SM",
            "1921720",
            "19251000SM",
            "1925800",
            "1925800SM",
            "2021720UV",
            "2021750",
            "2021800",
            "2021850",
            "2021850UV",
            "20251000",
            "2025650",
            "2025700",
            "2025800",
            "2025800SM",
            "2025800SMN",
            "2025850",
            "2121670SM",
            "2125650",
            "2125700",
            "2125800",
            "2221940",
            "23211125120SMFX",
            "23211125130",
            "2321112514051",
            "2321112512551",
            "2321750",
            "2325650",
            "2325800SM",
            "2421112512551",
            "2625650",
            "262575051",
            "2625800",
            "2625850SM",
            "2825850",
            "1R042325650",
            "FCL022325650",
            "SCL0223211125",
            "scl052325650",
            "test2025800"
        ];

        // API Configuration - ปรับปรุงให้รองรับการเปลี่ยนแปลง
        const API_CONFIG = {
            // Primary endpoint - กะ B (updated 2026-01-28 v2.3)
            endpoint: 'https://script.google.com/macros/s/AKfycbwh2viO76_yCWxKtCKW1svuFZX-x-QWKfpIgFkLKuXmsIp0RKVSXTvWfio-zlp0OB0AEA/exec',
            
            // Backup endpoints (สำหรับกรณี primary ล้มเหลว)
            backupEndpoints: [
                'https://script.google.com/macros/s/BACKUP_URL_1/exec',
                'https://script.google.com/macros/s/BACKUP_URL_2/exec'
            ],
            
            sheetId: '1ZhDdKmzZSK0koExN2u_JsiF_SLAOanYyGtuewNAkFYU',
            folderId: '1vGSCN4Qf8XZNewfhpscW4BNZaHV8lvpe',
            
            // Timeout และ retry settings
            timeout: 30000, // 30 วินาที
            maxRetries: 5,
            retryDelay: 2000, // 2 วินาที
            
            // Version tracking
            apiVersion: '2.3',
            lastUpdated: '2026-01-28'
        };

        // Global Variables
        let dataSetCount = 1;
        let autoSaveInterval;
        let debounceTimer;
    // Context for ADD_NEW to only update the originating select
    let addNewContext = null;
        
        // System Health Monitoring
        const SYSTEM_HEALTH = {
            lastSaveTime: null,
            saveFailureCount: 0,
            maxFailures: 10,
            isOnline: navigator.onLine,
            performanceMetrics: {
                loadTime: 0,
                saveTime: 0,
                errorCount: 0
            }
        };
        
        // Error Logging System
        const ERROR_LOG = {
            maxEntries: 100,
            entries: [],
            
            log: function(error, context = '') {
                const entry = {
                    timestamp: new Date().toISOString(),
                    error: error.toString(),
                    context: context,
                    userAgent: navigator.userAgent,
                    url: window.location.href
                };
                
                this.entries.unshift(entry);
                if (this.entries.length > this.maxEntries) {
                    this.entries.pop();
                }
                
                // Save to localStorage for debugging
                try {
                    LS.set('errorLog', JSON.stringify(this.entries));
                } catch (e) {
                    console.warn('Cannot save error log to localStorage');
                }
                
                console.error('System Error:', entry);
            },
            
            getRecentErrors: function(hours = 24) {
                const cutoff = new Date(Date.now() - hours * 60 * 60 * 1000);
                return this.entries.filter(entry => new Date(entry.timestamp) > cutoff);
            }
        };

        // Initialize System - ปรับปรุงให้แข็งแกร่งขึ้น
        document.addEventListener('DOMContentLoaded', function() {
            const startTime = performance.now();
            
            try {
                console.log('🚀 ระบบบันทึกข้อมูลรายงานแผนกผลิต 2 เริ่มต้นแล้ว');
                
                // Initialize system health monitoring
                initializeSystemHealth();
                
                // Setup error handling
                setupGlobalErrorHandling();
                
                // Initialize UI components
                updateCurrentTime();
                setInterval(updateCurrentTime, 1000);
                
                // Create initial data sets with error handling
                try {
                    const container = document.getElementById('dataContainer');
                    if (!container) {
                        throw new Error('Data container not found');
                    }
                    
                    for (let i = 1; i <= 1; i++) {
                        const newDataSet = document.createElement('div');
                        newDataSet.innerHTML = generateDataSet(i);
                        const el = newDataSet.firstElementChild;
                        if (el) {
                            try { el.style.opacity = '0'; el.style.transition = 'opacity 180ms ease-out'; el.style.visibility = 'hidden'; } catch(_){}
                            container.appendChild(el);
                                console.log('PD2: appended initial dataset', i, el);
                                PD2DebugBadge('B: append init #' + i);
                                requestAnimationFrame(() => {
                                    try {
                                        el.style.visibility = 'visible';
                                        void el.offsetWidth;
                                        el.style.opacity = '1';
                                        el.scrollIntoView && el.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                                        const prev = container.style.overflow; container.style.overflow = 'visible';
                                        setTimeout(() => { container.style.overflow = prev || ''; }, 300);
                                    } catch(_){ }
                                    setTimeout(() => {
                                        try {
                                            if (el.offsetHeight < 8 || getComputedStyle(el).opacity === '0') {
                                                el.style.display = '';
                                                el.style.visibility = 'visible';
                                                el.style.opacity = '1';
                                                PD2DebugBadge('B: force show init #' + i);
                                            }
                                        } catch(_){}
                                    }, 300);
                                });
                            requestAnimationFrame(() => {
                                try { el.style.visibility = 'visible'; void el.offsetWidth; el.style.opacity = '1'; } catch(_){}
                                try { const prev = container.style.overflow; container.style.overflow = 'visible'; setTimeout(() => { container.style.overflow = prev || ''; }, 300); } catch(_){}
                            });
                        }
                    }
                    dataSetCount = 1;
                    updateDataSetCount();
                } catch (error) {
                    ERROR_LOG.log(error, 'Initial data set creation');
                    showNotification('เกิดข้อผิดพลาดในการสร้างฟอร์ม กรุณาโหลดหน้าใหม่', 'error');
                }
                
                // Setup event listeners with error handling
                setupEventListeners();
                setupSelectHandlers();
                try { window.PD2_WAGE_B && window.PD2_WAGE_B.bindWageBForAllSets(); } catch(_){ }
                setupNetworkMonitoring();
                
                // Check for pending submissions
                checkForPendingSubmissions();
                
                // Setup auto-save with improved interval
                setupAutoSave();
                
                // Load existing data if available
                loadFromLocalStorage();
                
                // Performance tracking
                const loadTime = performance.now() - startTime;
                SYSTEM_HEALTH.performanceMetrics.loadTime = loadTime;
                console.log(`⚡ ระบบโหลดเสร็จใน ${loadTime.toFixed(2)}ms`);
                
                // แสดง notification เฉพาะเมื่อโหลดข้อมูลสำเร็จจริง
                const stored = LS.get('productionData');
                if (stored) {
                    setTimeout(() => {
                        showNotification('ระบบพร้อมใช้งาน', 'success');
                    }, 800);
                }
                
            } catch (error) {
                ERROR_LOG.log(error, 'System initialization');
                console.error('❌ เกิดข้อผิดพลาดในการเริ่มต้นระบบ:', error);
                showNotification('เกิดข้อผิดพลาดในการเริ่มต้นระบบ กรุณาโหลดหน้าใหม่', 'error');
            }
        });

        // System Health Functions
        function initializeSystemHealth() {
            // Check browser compatibility
            if (!window.localStorage) {
                showNotification('เบราว์เซอร์ไม่รองรับการบันทึกข้อมูล', 'warning');
            }
            
            // Check available storage
            try {
                const testKey = 'storageTest';
                localStorage.setItem(testKey, 'test');
                localStorage.removeItem(testKey);
            } catch (e) {
                showNotification('พื้นที่จัดเก็บข้อมูลเต็ม กรุณาล้างข้อมูลเก่า', 'warning');
            }
            
            SYSTEM_HEALTH.isOnline = navigator.onLine;
        }
        
        function setupGlobalErrorHandling() {
            // Handle uncaught errors
            window.addEventListener('error', function(event) {
                ERROR_LOG.log(event.error, `Global error: ${event.filename}:${event.lineno}`);
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
            
            // Handle unhandled promise rejections
            window.addEventListener('unhandledrejection', function(event) {
                ERROR_LOG.log(event.reason, 'Unhandled promise rejection');
                SYSTEM_HEALTH.performanceMetrics.errorCount++;
            });
        }
        
        function setupNetworkMonitoring() {
            // Monitor online/offline status
            window.addEventListener('online', function() {
                SYSTEM_HEALTH.isOnline = true;
                showNotification('เชื่อมต่ออินเทอร์เน็ตแล้ว', 'success');
                
                // Try to sync pending data
                checkForPendingSubmissions();
            });
            
            window.addEventListener('offline', function() {
                SYSTEM_HEALTH.isOnline = false;
                showNotification('ไม่มีการเชื่อมต่ออินเทอร์เน็ต ข้อมูลจะถูกบันทึกไว้ในเครื่อง', 'warning');
            });
        }
        
        function setupAutoSave() {
            // Clear existing interval if any
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            
            // Auto-save every 3 minutes (reduced from 5 for better reliability)
            autoSaveInterval = setInterval(() => {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Auto-save failed');
                }
            }, 180000);
            
            // Also save before page unload
            window.addEventListener('beforeunload', function(e) {
                try {
                    saveToLocalStorage();
                } catch (error) {
                    ERROR_LOG.log(error, 'Before unload save failed');
                }
            });
        }

        // Update current time display
        function updateCurrentTime() {
            try {
                const now = new Date();
                const timeString = now.toLocaleString('th-TH', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
                const timeElement = document.getElementById('currentTime');
                if (timeElement) {
                    timeElement.textContent = timeString;
                }
            } catch (error) {
                ERROR_LOG.log(error, 'Update time failed');
            }
        }

        // Setup Event Listeners
        function setupEventListeners() {
            // Prevent accidental page leave
            window.addEventListener('beforeunload', function(e) {
                const hasData = document.querySelectorAll('.data-set').length > 0;
                if (hasData) {
                    e.preventDefault();
                    e.returnValue = '';
                    saveToLocalStorage();
                }
            });

            // Auto-save on input changes
            document.addEventListener('input', function(e) {
                if (e.target.matches('.input-field')) {
                    clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(saveToLocalStorage, 2000);
                }
            });

            // Realtime WAGE_B updates (delegated)
            try {
                if (!document.__PD2_WAGE_B_REALTIME) {
                    const handler = (ev) => {
                        const t = ev && ev.target;
                        if (!t || !t.name) return;
                        const name = String(t.name);
                        // match fields that affect wage calc for B context on this page
                        const match = /^(meterStartA_|meterEndA_|lengthA_|fabricSize_|fabricSizeManual_)/.test(name);
                        if (!match) return;
                        const m = name.match(/_(\d+)$/);
                        const setNumber = m ? m[1] : null;
                        if (!setNumber) return;
                        try { window.PD2_WAGE_B && window.PD2_WAGE_B.updateWageBForSet(setNumber); } catch(_){}
                    };
                    document.addEventListener('input', handler, true);
                    document.addEventListener('change', handler, true);
                    document.__PD2_WAGE_B_REALTIME = true;
                }
            } catch(_){ }
        }

        // Generate Data Set HTML
        function generateDataSet(setNumber) {
            const today = new Date().toISOString().split('T')[0];
            
            return `
                <div class="data-set glass rounded-lg p-6 mb-6" data-set="${setNumber}">
                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-medium text-white flex items-center">
                            <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <defs>
                                    <linearGradient id="setGrad${setNumber}" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <rect fill="url(#setGrad${setNumber})" x="3" y="4" width="18" height="15" rx="2" ry="2"/>
                                <polyline stroke="white" stroke-width="2" points="16,10 12,14 8,10"/>
                            </svg>
                            ${t('dataset.number')} ${setNumber}
                        </h2>
                        ${setNumber > 1 ? `
                            <button onclick="removeDataSet(${setNumber})" class="btn-glow btn-red text-white px-3 py-2 rounded-lg font-normal text-sm flex items-center">
                                <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24">
                                    <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                                </svg>
                                ลบชุดข้อมูล
                            </button>
                        ` : ''}
                    </div>

                    <!-- mobile responsive fix: stack columns on small screens -->
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <!-- ข้อมูลพื้นฐาน -->
                        <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                            <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <defs>
                                        <linearGradient id="basicGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                            <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                            <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
                                        </linearGradient>
                                    </defs>
                                    <circle fill="url(#basicGrad)" cx="12" cy="12" r="10"/>
                                    <path stroke="white" stroke-width="2" d="m9 12 2 2 4-4"/>
                                </svg>
                                ${t('section.basic')}
                            </h3>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block font-medium mb-2 text-base">${t('field.date')}</label>
                                    <input type="date" name="date_${setNumber}" value="${today}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base">${t('field.machine')}</label>
                                    <select name="machine_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">${t('field.machine.select')}</option>
                                        ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                                    </select>
                                    <div class="mt-3">
                                        <label class="block font-medium mb-2 text-base">${t('field.machine.custom')}</label>
                                        <input type="text" name="machineManual_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.machine.placeholder')}">
                                        <p class="text-xs text-gray-200 mt-1">${t('helper.select')}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base">${t('field.employee.b')}</label>
                                    <select name="employeeA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">${t('field.employee.select')}</option>
                                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                                    </select>
                                    <div class="mt-3">
                                        <label class="block font-medium mb-2 text-base">${t('field.employee.custom.b')}</label>
                                        <input type="text" name="employeeAManual_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.employee.placeholder')}">
                                        <p class="text-xs text-gray-200 mt-1">${t('helper.select')}</p>
                                    </div>
                                </div>
                                
                                <div>
                                    <label class="block font-medium mb-2 text-base">${t('field.fabric.size')}</label>
                                    <select name="fabricSize_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg">
                                        <option value="">${t('field.fabric.select')}</option>
                                        ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                                    </select>
                                    <div class="mt-3">
                                        <label class="block font-medium mb-2 text-base">${t('field.fabric.custom')}</label>
                                        <input type="text" name="fabricSizeManual_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.fabric.placeholder')}">
                                        <p class="text-xs text-gray-200 mt-1">${t('helper.select')}</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- เลขมิเตอร์ + ความยาว+ค่าแรง (เรียงตั้งทางขวา) -->
                        <div class="space-y-6">
                            <!-- เลขมิเตอร์ประจำวัน -->
                            <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                                <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <defs>
                                            <linearGradient id="meterGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                        <circle fill="url(#meterGrad)" cx="12" cy="12" r="10"/>
                                        <polyline stroke="white" stroke-width="2" points="12,6 12,12 16,14"/>
                                    </svg>
                                    ${t('section.meter')}
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">${t('field.meter.start.b')}</label>
                                        <input type="number" name="meterStartA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.meter.placeholder')}">
                                    </div>
                                    
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">${t('field.meter.end.b')}</label>
                                        <input type="number" name="meterEndA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.meter.placeholder.end')}">
                                    </div>
                                </div>
                            </div>

                            <!-- ความยาวและค่าแรง -->
                            <div class="glass-light rounded-lg p-4" style="background: rgba(255, 255, 255, 0.04); backdrop-filter: blur(3px);">
                                <h3 class="text-lg font-normal text-white mb-4 flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <defs>
                                            <linearGradient id="lengthGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#0891b2;stop-opacity:1" />
                                            </linearGradient>
                                            <filter id="lengthGlow">
                                                <feGaussianBlur stdDeviation="2" result="coloredBlur"/>
                                                <feMerge> 
                                                    <feMergeNode in="coloredBlur"/>
                                                    <feMergeNode in="SourceGraphic"/>
                                                </feMerge>
                                            </filter>
                                        </defs>
                                        <circle fill="url(#lengthGrad)" cx="12" cy="12" r="10" filter="url(#lengthGlow)"/>
                                        <path stroke="white" stroke-width="2" d="M8 8h8M8 12h8M8 16h8"/>
                                        <circle fill="white" cx="6" cy="8" r="1"/>
                                        <circle fill="white" cx="6" cy="12" r="1"/>
                                        <circle fill="white" cx="6" cy="16" r="1"/>
                                        <path stroke="white" stroke-width="1.5" d="M18 6v12"/>
                                    </svg>
                                    ${t('section.length')}
                                </h3>
                                
                                <div class="space-y-4">
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">${t('field.length')}</label>
                                        <input type="number" name="lengthA_${setNumber}" class="input-field w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.length.placeholder')}" step="0.01">
                                    </div>
                                    
                                    <div>
                                        <label class="block font-medium mb-2 text-base" style="color: white; font-weight: 450; transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);">${t('field.wage.b')}</label>
                                        <input type="text" name="wageB_${setNumber}" class="input-field wage-a-input w-full p-3 border border-gray-300 rounded-lg" placeholder="${t('field.wage.placeholder')}" inputmode="decimal" autocomplete="off" readonly>
                                        <p class="text-xs text-red-500 mt-1 hidden" data-wageB-error="${setNumber}"></p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>


                </div>
            `;
        }

        // Add Data Set
        function addDataSet() {
            if (dataSetCount >= 100) {
                showNotification('ไม่สามารถเพิ่มชุดข้อมูลได้ เนื่องจากถึงขีดจำกัด 100 ชุด', 'error');
                return;
            }
            
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            if (newElement) {
                try { newElement.style.opacity = '0'; newElement.style.transition = 'opacity 180ms ease-out'; newElement.style.visibility = 'hidden'; } catch(_){}
                container.appendChild(newElement);
                    console.log('PD2: appended new dataset', dataSetCount, newElement);
                    PD2DebugBadge('B: append #' + dataSetCount);
                    requestAnimationFrame(() => {
                        try {
                            newElement.style.visibility = 'visible'; void newElement.offsetWidth; newElement.style.opacity = '1';
                            newElement.scrollIntoView && newElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            const prev = container.style.overflow; container.style.overflow = 'visible';
                            setTimeout(() => { container.style.overflow = prev || ''; }, 300);
                        } catch(_){ }
                        setTimeout(() => {
                            try {
                                if (newElement.offsetHeight < 8 || getComputedStyle(newElement).opacity === '0') {
                                    newElement.style.display = '';
                                    newElement.style.visibility = 'visible';
                                    newElement.style.opacity = '1';
                                    PD2DebugBadge('B: force show #' + dataSetCount);
                                }
                            } catch(_){}
                        }, 300);
                    });
                try { newElement.style.display = ''; newElement.classList.remove('hidden','invisible'); newElement.removeAttribute('hidden'); } catch(_){ }
                requestAnimationFrame(() => {
                    try {
                        newElement.style.visibility = 'visible'; void newElement.offsetWidth; newElement.style.opacity = '1'; newElement.classList.remove('data-set'); void newElement.offsetWidth; newElement.classList.add('data-set'); newElement.style.transform = 'none'; newElement.style.zIndex = '10';
                        try { const prev = container.style.overflow; container.style.overflow = 'visible'; setTimeout(() => { container.style.overflow = prev || ''; }, 300); } catch(_){ }
                    } catch(_){ }
                });
            }

            updateDataSetCount();
            
            // Setup handlers after a short delay to ensure DOM is ready
            setTimeout(() => {
                setupSelectHandlers();
                try { window.PD2_WAGE_B && window.PD2_WAGE_B.bindWageBForAllSets(); } catch(_){ }
                showNotification(`เพิ่มชุดข้อมูลที่ ${dataSetCount} เรียบร้อยแล้ว`, 'green');
                
                // Scroll to new data set
                newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Copy and Add Data Set
        function copyAndAddDataSet() {
            if (dataSetCount >= 100) {
                showNotification('ไม่สามารถเพิ่มชุดข้อมูลได้ เนื่องจากถึงขีดจำกัด 100 ชุด', 'error');
                return;
            }
            
            const lastDataSet = document.querySelector(`[data-set="${dataSetCount}"]`);
            if (!lastDataSet) {
                addDataSet();
                return;
            }
            
            // Define fields to copy (เฉพาะฟิลด์ที่ต้องการ)
            const fieldsToCopy = [
                'date',              // วันที่
                'employeeA',         // ชื่อพนักงานทอ กะ A (dropdown)
                'employeeAManual'    // ชื่อพนักงานทอ กะ A (กรอกเอง)
            ];
            
            // Get data from last set (เฉพาะฟิลด์ที่ระบุ)
            const lastData = {};
            const inputs = lastDataSet.querySelectorAll('input, select');
            inputs.forEach(input => {
                const fieldName = input.name.replace(`_${dataSetCount}`, '');
                // เก็บเฉพาะฟิลด์ที่อยู่ใน fieldsToCopy
                if (fieldsToCopy.includes(fieldName)) {
                    // สำหรับ date เก็บเสมอ (แม้ค่าว่าง), สำหรับ employee เก็บเฉพาะที่มีค่า
                    if (!input.readOnly && !input.disabled) {
                        if (fieldName === 'date' || input.value) {
                            lastData[fieldName] = input.value;
                        }
                    }
                }
            });
            
            // Create new data set
            dataSetCount++;
            const container = document.getElementById('dataContainer');
            const newDataSet = document.createElement('div');
            newDataSet.innerHTML = generateDataSet(dataSetCount);
            const newElement = newDataSet.firstElementChild;
            if (newElement) {
                try { newElement.style.opacity = '0'; newElement.style.transition = 'opacity 180ms ease-out'; newElement.style.visibility = 'hidden'; } catch(_){}
                container.appendChild(newElement);
                    console.log('PD2: appended copied dataset', dataSetCount, newElement);
                    PD2DebugBadge('B: append copy #' + dataSetCount);
                    requestAnimationFrame(() => {
                        try {
                            newElement.style.visibility = 'visible'; void newElement.offsetWidth; newElement.style.opacity = '1';
                            newElement.scrollIntoView && newElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                            const prev = container.style.overflow; container.style.overflow = 'visible';
                            setTimeout(() => { container.style.overflow = prev || ''; }, 300);
                        } catch(_){ }
                        setTimeout(() => {
                            try {
                                if (newElement.offsetHeight < 8 || getComputedStyle(newElement).opacity === '0') {
                                    newElement.style.display = '';
                                    newElement.style.visibility = 'visible';
                                    newElement.style.opacity = '1';
                                    PD2DebugBadge('B: force show copy #' + dataSetCount);
                                }
                            } catch(_){}
                        }, 300);
                    });
                try { newElement.style.display = ''; newElement.classList.remove('hidden','invisible'); newElement.removeAttribute('hidden'); } catch(_){ }
                requestAnimationFrame(() => {
                    try { newElement.style.visibility = 'visible'; void newElement.offsetWidth; newElement.style.opacity = '1'; newElement.classList.remove('data-set'); void newElement.offsetWidth; newElement.classList.add('data-set'); } catch(_){ }
                });
            }
            
            // Fill with copied data after a short delay to ensure DOM is ready
            setTimeout(() => {
                const newInputs = newElement.querySelectorAll('input, select');
                newInputs.forEach(input => {
                    if (!input.readOnly && !input.disabled) {
                        const fieldName = input.name.replace(`_${dataSetCount}`, '');
                        // คัดลอกเฉพาะฟิลด์ที่ระบุ ฟิลด์อื่นจะเป็นค่าว่าง
                        if (lastData[fieldName]) {
                            input.value = lastData[fieldName];
                        }
                    }
                });
                
                // Setup handlers for the new data set
                setupSelectHandlers();
                try { window.PD2_WAGE_B && window.PD2_WAGE_B.bindWageBForAllSets(); } catch(_){ }
                
                showNotification(`คัดลอกและเพิ่มชุดข้อมูลที่ ${dataSetCount} เรียบร้อยแล้ว `, 'blue');
                
                // Scroll to new data set
                newElement.scrollIntoView({ behavior: 'smooth' });
            }, 100);
            
            updateDataSetCount();
        }

        // Remove Data Set
        function removeDataSet(setNumber) {
            if (dataSetCount <= 1) {
                showNotification('ไม่สามารถลบชุดข้อมูลสุดท้ายได้', 'error');
                return;
            }
            
            const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
            if (dataSet) {
                dataSet.remove();
                dataSetCount--;
                updateDataSetCount();
                showNotification(`ลบชุดข้อมูลที่ ${setNumber} เรียบร้อยแล้ว`, 'green');
            }
        }

        // Update Data Set Count Display
        function updateDataSetCount() {
            document.getElementById('dataSetCount').textContent = dataSetCount;
        }


        // Setup Select Handlers
        function setupSelectHandlers() {
            document.querySelectorAll('select').forEach(select => {
                select.addEventListener('change', function() {
                    if (this.value === 'ADD_NEW') {
                        const fieldType = this.name.includes('machine') ? 'machine' : 
                                        this.name.includes('employee') ? 'employee' : 'fabric';
                        // remember where ADD_NEW came from
                        addNewContext = { type: fieldType, selectName: this.name, setNumber: (this.name.split('_')[1]||'').trim(), selectEl: this };
                        openModal(fieldType);
                        this.value = ''; // Reset select
                        return;
                    }

                    // Sync selected value into corresponding manual input automatically
                    try {
                        const setNumber = (this.name.split('_')[1] || '').trim();
                        if (!setNumber) return;
                        if (this.name.startsWith('machine_')) {
                            const manual = document.querySelector(`input[name="machineManual_${setNumber}"]`);
                            if (manual) manual.value = this.value || '';
                        } else if (this.name.startsWith('employeeA_')) {
                            const manual = document.querySelector(`input[name="employeeAManual_${setNumber}"]`);
                            if (manual) {
                                if (this.value) {
                                    const opt = this.options[this.selectedIndex];
                                    manual.value = opt && opt.text ? opt.text : this.value;
                                } else {
                                    manual.value = '';
                                }
                            }
                        } else if (this.name.startsWith('fabricSize_')) {
                            const manual = document.querySelector(`input[name="fabricSizeManual_${setNumber}"]`);
                            if (manual) manual.value = this.value || '';
                        }
                    } catch(_) {}
                });
            });

            // ซิงก์ฟิลด์กรอกเอง -> select เดิม
        document.querySelectorAll('input[name^="employeeAManual_"]').forEach(inp => {
                inp.addEventListener('input', function() {
                    const setNumber = this.name.split('_')[1];
            const sel = document.querySelector(`select[name="employeeA_${setNumber}"]`);
                    const v = (this.value || '').trim();
                    if (!sel) return;
                    const byId = employees.find(e => v.toUpperCase().startsWith(e.id.toUpperCase()));
                    const byPair = employees.find(e => (e.id + ' - ' + e.name) === v);
                    const match = byPair || byId;
                    sel.value = match ? match.id : '';
                });
                // no show/hide toggling
            });

            // สำหรับเครื่องทอ NO (กรอกเอง) -> ซิงก์กลับไปที่ select หากตรงรายการ
            document.querySelectorAll('input[name^="machineManual_"]').forEach(inp => {
                inp.addEventListener('input', function() {
                    const setNumber = this.name.split('_')[1];
                    const sel = document.querySelector(`select[name="machine_${setNumber}"]`);
                    const v = (this.value || '').trim();
                    if (!sel) return;
                    const up = v.toUpperCase();
                    const found = machines.find(m => m.toUpperCase() === up || m.toUpperCase().startsWith(up));
                    sel.value = found ? found : '';
                });
            });

        document.querySelectorAll('input[name^="fabricSizeManual_"]').forEach(inp => {
                inp.addEventListener('input', function() {
                    const setNumber = this.name.split('_')[1];
            const sel = document.querySelector(`select[name="fabricSize_${setNumber}"]`);
                    const v = (this.value || '').trim();
                    if (!sel) return;
                    const found = fabricSizes.find(s => s.toUpperCase() === v.toUpperCase());
                    sel.value = found ? found : '';
                });
                // no show/hide toggling
            });

            // ติดตั้งระบบแนะนำแบบทันที (instant suggestions)
            try {
                document.querySelectorAll('input[name^="employeeAManual_"]').forEach(inp => {
                    attachInstantSuggestions(inp, () => employees.map(e => ({
                        label: `${e.id} - ${e.name}`,
                        value: `${e.id} - ${e.name}`,
                        key: `${e.id} ${e.name}`.toLowerCase()
                    })));
                });
                // สำหรับเครื่องทอ NO
                document.querySelectorAll('input[name^="machineManual_"]').forEach(inp => {
                    attachInstantSuggestions(inp, () => machines.map(m => ({
                        label: m,
                        value: m,
                        key: m.toLowerCase()
                    })));
                });
                document.querySelectorAll('input[name^="fabricSizeManual_"]').forEach(inp => {
                    attachInstantSuggestions(inp, () => fabricSizes.map(s => ({
                        label: s,
                        value: s,
                        key: s.toLowerCase()
                    })));
                });
            } catch(_) {}
        }

        

        // Modal Functions
        function openModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.remove('hidden');
            
            // Clear previous inputs
            if (type === 'employee') {
                document.getElementById('newEmployeeId').value = '';
                document.getElementById('newEmployeeName').value = '';
            } else {
                document.getElementById(`new${type.charAt(0).toUpperCase() + type.slice(1)}${type === 'fabric' ? 'Size' : ''}`).value = '';
            }
        }

        function closeModal(type) {
            const modal = document.getElementById(`${type}Modal`);
            modal.classList.add('hidden');
        }

        // Success Modal with Auto-Reset Countdown
        let countdownInterval = null;
        let countdownSeconds = 90;

        function showSuccessModal(totalRows) {
            const modal = document.getElementById('successModal');
            const countElement = document.getElementById('successModalCount');
            const timerElement = document.getElementById('countdownTimer');
            
            if (countElement) countElement.textContent = totalRows;
            if (modal) modal.classList.remove('hidden');
            
            // เริ่ม countdown
            countdownSeconds = 90;
            if (timerElement) timerElement.textContent = countdownSeconds;
            
            // Clear interval เก่าถ้ามี
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            // เริ่ม countdown timer
            countdownInterval = setInterval(() => {
                countdownSeconds--;
                if (timerElement) timerElement.textContent = countdownSeconds;
                
                if (countdownSeconds <= 0) {
                    clearInterval(countdownInterval);
                    countdownInterval = null;
                    continueWithSameEmployee(); // กรอกข้อมูลต่อเมื่อหมดเวลา
                }
            }, 1000);
            
            console.log('✅ Success modal shown with', totalRows, 'rows');
        }

        function closeSuccessModal() {
            const modal = document.getElementById('successModal');
            if (modal) modal.classList.add('hidden');
            
            // Clear countdown
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
        }

        function continueWithSameEmployee() {
            console.log('🔄 พนักงานเดิมเลือกกรอกข้อมูลต่อ');
            closeSuccessModal();
            // ไม่ต้อง reset อะไร - เก็บข้อมูลไว้
            showNotification('สามารถกรอกข้อมูลต่อได้เลย', 'blue');
        }

        function resetForNextEmployee() {
            console.log('✨ เริ่มใหม่สำหรับพนักงานคนถัดไป');
            closeSuccessModal();
            
            // รีเซ็ตฟอร์มทั้งหมด
            try {
                resetToSingleDataSet();
                showNotification('ระบบพร้อมสำหรับพนักงานคนถัดไป!', 'green');
            } catch (error) {
                console.error('❌ เกิดข้อผิดพลาดในการ reset:', error);
                showNotification('เกิดข้อผิดพลาดในการรีเซ็ต', 'error');
            }
        }

        // Fallback showNotification if not available from parent
        if (typeof showNotification === 'undefined') {
            window.showNotification = function(message, type) {
                console.log('[Notification]', type, ':', message);
                // Try parent window notification
                try {
                    if (window.parent && window.parent !== window && window.parent.PD2Notify) {
                        window.parent.PD2Notify(message, type);
                    } else {
                        alert(message);
                    }
                } catch (e) {
                    alert(message);
                }
            };
        }

        // ===========================
        // Wage (Shift-B) calculation
        // ===========================
        (function(){
            "use strict";

            function toNumberSafe(value) {
                if (value == null) return null;
                if (typeof value === "number") return Number.isFinite(value) ? value : null;
                if (typeof value === "string") {
                    let s = value.trim();
                    if (s === "") return null;
                    // Thai digits -> Arabic
                    s = s.replace(/[\u0E50-\u0E59]/g, (ch) => String(ch.charCodeAt(0) - 0x0E50));
                    s = s.replace(/[\,\s]/g, "");
                    const n = Number(s);
                    return Number.isFinite(n) ? n : null;
                }
                return null;
            }

            function extractSizeFromRow(row) {
                const v1 = toNumberSafe(row["ขนาดหน้าผ้า (กรอกเอง)"]);
                if (v1 != null) return v1;
                const v2 = toNumberSafe(row["ขนาดหน้าผ้า"]);
                if (v2 != null) return v2;
                return null;
            }

            function extractSizeFromCode(code) {
                    if (!code) return null;
                    code = String(code).toUpperCase();
                    try {
                        // Special-case: any SCL code (case-insensitive) -> take characters at positions 6 and 7 (1-based)
                        if (code.includes("SCL")) {
                            const part = code.slice(5, 7);
                            const n = parseInt(part, 10);
                            return Number.isFinite(n) ? n : null;
                        }

                        if (code.startsWith("FCL")) return parseInt(code.slice(5, 7), 10);
                        if (code.startsWith("TEST")) return parseInt(code.slice(4, 6), 10);
                        return parseInt(code.slice(0, 2), 10);
                    } catch(_) { return null; }
            }

            function getSize(row) {
                const sizeNum = extractSizeFromRow(row);
                if (sizeNum != null && Number.isFinite(sizeNum)) return sizeNum;
                const codeFields = ["รหัสสินค้า", "รหัสผ้า", "โค้ด", "code", "Code", "ITEM CODE"];
                for (const k of codeFields) {
                    if (k in row) {
                        const sz = extractSizeFromCode(row[k]);
                        if (Number.isFinite(sz)) return sz;
                    }
                }
                return null;
            }

            function getRate(size) {
                if (!size) return 0;
                if (size >= 12 && size <= 17) return 0.13;
                if (size >= 18 && size <= 22) return 0.14;
                if (size >= 23 && size <= 25) return 0.15;
                if (size >= 26 && size <= 30) return 0.18;
                return 0;
            }

            // On the Shift-B page, B shift inputs are named with suffix A
            function calcOutputB(row) {
                const start = toNumberSafe(row["เลขมิเตอร์ประจำวัน กะ B: เริ่มงาน"]);
                const end = toNumberSafe(row["เลขมิเตอร์ประจำวัน กะ B: เลิกงาน"]);
                const cutLen = toNumberSafe(row["ความยาวตัดม้วน (เมตร) กะ B"]);
                if (start == null || end == null) return null;
                if (start <= end) return Math.max(0, end - start);
                if (cutLen != null) {
                    const diff = start - end;
                    return Math.max(0, cutLen - diff);
                }
                return null;
            }

            function calculateWageB(row) {
                const size = getSize(row);
                const outputB = calcOutputB(row);
                if (outputB == null) return null;
                const rate = getRate(size);
                const unit = rate > 0 ? rate : (Number.isFinite(size) ? size : 0);
                const wage = outputB * unit;
                return Number(wage.toFixed(2));
            }

            function buildRowForSet(setNumber) {
                const qs = (sel) => document.querySelector(sel);
                const fabSel = qs(`[name="fabricSize_${setNumber}"]`)?.value || "";
                const fabManual = qs(`[name=\"fabricSizeManual_${setNumber}\"]`)?.value || "";
                const row = {
                    "ขนาดหน้าผ้า": "",
                    "ขนาดหน้าผ้า (กรอกเอง)": "",
                    "เลขมิเตอร์ประจำวัน กะ B: เริ่มงาน": qs(`[name="meterStartA_${setNumber}"]`)?.value || "",
                    "เลขมิเตอร์ประจำวัน กะ B: เลิกงาน": qs(`[name="meterEndA_${setNumber}"]`)?.value || "",
                    "ความยาวตัดม้วน (เมตร) กะ B": qs(`[name="lengthA_${setNumber}"]`)?.value || ""
                };
                if (fabManual) {
                    const n = toNumberSafe(fabManual);
                    if (n != null && n <= 100) {
                        row["ขนาดหน้าผ้า (กรอกเอง)"] = String(n);
                    } else {
                        row["โค้ด"] = fabManual;
                    }
                } else if (fabSel) {
                    row["โค้ด"] = fabSel;
                }
                return row;
            }

            function showWageError(setNumber, msg) {
                try {
                    const p = document.querySelector(`[data-wageB-error="${setNumber}"]`);
                    if (!p) return;
                    if (msg) { p.textContent = msg; p.classList.remove('hidden'); }
                    else { p.textContent = ''; p.classList.add('hidden'); }
                } catch(_) {}
            }

            function updateWageBForSet(setNumber) {
                try {
                    const input = document.querySelector(`[name="wageB_${setNumber}"]`);
                    if (!input) return;
                    const row = buildRowForSet(setNumber);
                    const val = calculateWageB(row);
                    if (val == null) {
                        input.value = '';
                        input.classList.remove('valid');
                        showWageError(setNumber, '');
                    } else {
                        input.value = Number(val).toFixed(2);
                        input.classList.add('valid');
                        showWageError(setNumber, '');
                    }
                } catch(e) { console.warn('WageB update failed:', e); }
            }

            function bindWageBListenersForSet(setNumber) {
                const sel = (n) => document.querySelector(`[name="${n}_${setNumber}"]`);
                ['meterStartA','meterEndA','lengthA'].forEach(fn => {
                    const el = sel(fn);
                    if (el && !el.dataset.wageBoundB) {
                        el.dataset.wageBoundB = '1';
                        el.addEventListener('input', () => updateWageBForSet(setNumber));
                        el.addEventListener('change', () => updateWageBForSet(setNumber));
                    }
                });
                ['fabricSize','fabricSizeManual'].forEach(fn => {
                    const el = sel(fn);
                    if (el && !el.dataset.wageBoundB) {
                        el.dataset.wageBoundB = '1';
                        el.addEventListener('input', () => updateWageBForSet(setNumber));
                        el.addEventListener('change', () => updateWageBForSet(setNumber));
                    }
                });

                // wageB is computed only; input is readonly and self-edit handlers removed

                updateWageBForSet(setNumber);
            }

            function bindWageBForAllSets() {
                document.querySelectorAll('.data-set').forEach(ds => {
                    const setNumber = ds.getAttribute('data-set');
                    if (setNumber) bindWageBListenersForSet(setNumber);
                });
            }

            window.PD2_WAGE_B = {
                toNumberSafe,
                extractSizeFromRow,
                extractSizeFromCode,
                getSize,
                getRate,
                calcOutputB,
                calculateWageB,
                updateWageBForSet,
                bindWageBForAllSets
            };
        })();

    function saveModalData(type) {
            let newValue = '';
            let isValid = false;
            
            if (type === 'employee') {
                const id = document.getElementById('newEmployeeId').value.trim();
                const name = document.getElementById('newEmployeeName').value.trim();
                
                if (id && name) {
                    newValue = id;
                    if (!employees.some(e => e.id === id)) {
                        employees.push({ id: id, name: name });
                    }
                    isValid = true;
                }
            } else if (type === 'machine') {
                newValue = document.getElementById('newMachine').value.trim();
                if (newValue) {
                    if (!machines.includes(newValue)) {
                        machines.push(newValue);
                    }
                    isValid = true;
                }
            } else if (type === 'fabric') {
                newValue = document.getElementById('newFabricSize').value.trim();
                if (newValue) {
                    if (!fabricSizes.includes(newValue)) {
                        fabricSizes.push(newValue);
                    }
                    isValid = true;
                }
            }
            
            if (isValid) {
                try {
                    if (window.parent && window.parent !== window) {
                        if (type === 'employee') {
                            const emp = employees.find(e => e.id === newValue);
                            window.parent.postMessage({ type: 'PD2_ADD_CUSTOM', category: 'employee', data: { id: emp.id, name: emp.name } }, '*');
                        } else if (type === 'machine') {
                            window.parent.postMessage({ type: 'PD2_ADD_CUSTOM', category: 'machine', data: { value: newValue } }, '*');
                        } else if (type === 'fabric') {
                            window.parent.postMessage({ type: 'PD2_ADD_CUSTOM', category: 'fabric', data: { value: newValue } }, '*');
                        }
                    }
                } catch(_){}

                // Update options everywhere but select the new value only on the originating select
                const originName = (addNewContext && addNewContext.type === type) ? addNewContext.selectName : null;
                updateAllSelects(type, newValue, originName);
                addNewContext = null;
                closeModal(type);
                showNotification(`เพิ่มข้อมูลใหม่เรียบร้อยแล้ว`, 'success');
            } else {
                showNotification('กรุณากรอกข้อมูลให้ครบถ้วน', 'error');
            }
        }

        // Update All Selects
        function updateAllSelects(type, newValue, originSelectName) {
            const query = `select[name*="${type === 'employee' ? 'employee' : type === 'fabric' ? 'fabricSize' : 'machine'}"]`;
            const selects = document.querySelectorAll(query);

            selects.forEach(select => {
                const isOrigin = (originSelectName && select.name === originSelectName);
                const prevValue = select.value;
                // Remove old ADD_NEW option
                const addNewOption = select.querySelector('option[value="ADD_NEW"]');
                if (addNewOption) addNewOption.remove();

                // Add new option only if not exists
                let exists = Array.from(select.options).some(o => o.value === newValue);
                if (!exists) {
                    const opt = document.createElement('option');
                    if (type === 'employee') {
                        const emp = employees.find(e => e.id === newValue);
                        opt.value = newValue;
                        opt.textContent = emp ? `${emp.id} - ${emp.name}` : newValue;
                    } else {
                        opt.value = newValue; opt.textContent = newValue;
                    }
                    select.appendChild(opt);
                }

                // Re-add ADD_NEW option
                const addNewOptionNew = document.createElement('option');
                addNewOptionNew.value = 'ADD_NEW';
                addNewOptionNew.textContent = 'คีย์ข้อมูลใหม่';
                select.appendChild(addNewOptionNew);

                // Restore previous selection for others; set new value only for origin
                if (isOrigin) {
                    select.value = newValue;
                    // If fabric, also sync its manual input for this set
                    if (type === 'fabric') {
                        const setNumber = (select.name.split('_')[1]||'').trim();
                        const manual = document.querySelector(`[name="fabricSizeManual_${setNumber}"]`);
                        if (manual) manual.value = newValue;
                    }
                } else {
                    select.value = prevValue === 'ADD_NEW' ? '' : prevValue;
                }
            });

            refreshAllDatalists();
        }

        // Refresh All Selects
        function refreshAllSelects() {
            // Refresh machine selects
            document.querySelectorAll('select[name*="machine"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">เลือกเครื่องทอ</option>
                    ${machines.map(machine => `<option value="${machine}">${machine}</option>`).join('')}
                    <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                `;
                select.value = currentValue;
            });
            
            // Refresh employee selects
            document.querySelectorAll('select[name*="employee"]').forEach(select => {
                if (!select.name.includes('employeeB')) {
                    const currentValue = select.value;
                    select.innerHTML = `
                        <option value="">เลือกพนักงาน</option>
                        ${employees.map(emp => `<option value="${emp.id}">${emp.id} - ${emp.name}</option>`).join('')}
                        <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                    `;
                    select.value = currentValue;
                }
            });
            
            // Refresh fabric selects
            document.querySelectorAll('select[name*="fabricSize"]').forEach(select => {
                const currentValue = select.value;
                select.innerHTML = `
                    <option value="">เลือกขนาดหน้าผ้า</option>
                    ${fabricSizes.map(size => `<option value="${size}">${size}</option>`).join('')}
                    <option value="ADD_NEW">คีย์ข้อมูลใหม่</option>
                `;
                select.value = currentValue;
            });

            refreshAllDatalists();
        }

        function refreshAllDatalists() {
            document.querySelectorAll('datalist[id^="employeeList_"]').forEach(dl => {
                const html = employees.map(emp => `<option value="${emp.id} - ${emp.name}"></option>`).join('');
                dl.innerHTML = html;
            });
            document.querySelectorAll('datalist[id^="fabricSizeList_"]').forEach(dl => {
                const html = fabricSizes.map(size => `<option value="${size}"></option>`).join('');
                dl.innerHTML = html;
            });
        }

        function mergeSharedLists(shared) {
            if (!shared) return;
            (shared.machines||[]).forEach(m => { if (!machines.includes(m)) machines.push(m); });
            (shared.fabricSizes||[]).forEach(f => { if (!fabricSizes.includes(f)) fabricSizes.push(f); });
            (shared.employees||[]).forEach(emp => { if (!employees.some(e => e.id === emp.id)) employees.push(emp); });
            try { refreshAllSelects(); } catch(_) {}
        }

        try {
            if (window.parent && window.parent !== window) {
                window.parent.postMessage({ type: 'PD2_REQUEST_SYNC' }, '*');
            }
        } catch(_) {}

        window.addEventListener('message', (ev) => {
            const m = ev?.data;
            if (m && m.type === 'PD2_SYNC_CUSTOM') {
                mergeSharedLists(m.payload);
            }
        });

        // Field Validation Functions
        function validateAllData(allData) {
            const emptyFields = [];
            const requiredFields = ['date', 'machine', 'employeeA', 'fabricSize', 'meterStartA', 'meterEndA'];
            
            allData.forEach((dataSet, index) => {
                requiredFields.forEach(field => {
                    const value = dataSet[field];
                    // ตรวจสอบว่าค่าว่าง หรือเป็น 'ADD_NEW' (ค่าที่เลือกเพื่อเปิด modal)
                    if (!value || value.toString().trim() === '' || value === 'ADD_NEW') {
                        emptyFields.push({
                            setIndex: index,
                            field: field,
                            label: getFieldLabel(field)
                        });
                    }
                });
            });
            
            if (emptyFields.length > 0) {
                const fieldLabels = [...new Set(emptyFields.map(f => f.label))].join(', ');
                return {
                    isValid: false,
                    message: `กรุณากรอกข้อมูลให้ครบถ้วน: ${fieldLabels}`,
                    emptyFields: emptyFields
                };
            }
            
            return { isValid: true, message: '', emptyFields: [] };
        }
        
        function getFieldLabel(field) {
            const labels = {
                'date': 'วันที่',
                'machine': 'เครื่องจักร',
                'employeeA': 'พนักงาน A',
                'fabricSize': 'ขนาดผ้า',
                'meterStartA': 'เมตรเริ่ม A',
                'meterEndA': 'เมตรจบ A'
            };
            return labels[field] || field;
        }
        
        function highlightEmptyFields(emptyFields) {
            // Remove all existing error highlights and animations first
            document.querySelectorAll('.error-field').forEach(el => {
                el.classList.remove('error-field', 'shake-animation');
            });
            
            if (emptyFields.length === 0) return;
            
            let firstErrorField = null;
            
            // Highlight empty fields
            emptyFields.forEach(({ setIndex, field }) => {
                const dataSetElement = document.querySelectorAll('.data-set')[setIndex];
                if (!dataSetElement) return;
                
                const setNumber = setIndex + 1;
                let fieldElement = null;
                
                // Find field by name attribute
                if (field === 'date') {
                    fieldElement = dataSetElement.querySelector(`[name="date_${setNumber}"]`);
                } else if (field === 'machine') {
                    // ให้ความสำคัญกับ manual input ถ้ามีค่า, ไม่เช่นนั้นใช้ select
                    const selectEl = dataSetElement.querySelector(`[name="machine_${setNumber}"]`);
                    const manualEl = dataSetElement.querySelector(`[name="machineManual_${setNumber}"]`);
                    const manualVal = manualEl?.value?.trim() || '';
                    fieldElement = manualVal ? manualEl : selectEl;
                } else if (field === 'employeeA') {
                    const selectEl = dataSetElement.querySelector(`[name="employeeA_${setNumber}"]`);
                    const manualEl = dataSetElement.querySelector(`[name="employeeAManual_${setNumber}"]`);
                    const manualVal = manualEl?.value?.trim() || '';
                    fieldElement = manualVal ? manualEl : selectEl;
                } else if (field === 'fabricSize') {
                    const selectEl = dataSetElement.querySelector(`[name="fabricSize_${setNumber}"]`);
                    const manualEl = dataSetElement.querySelector(`[name="fabricSizeManual_${setNumber}"]`);
                    const manualVal = manualEl?.value?.trim() || '';
                    fieldElement = manualVal ? manualEl : selectEl;
                } else if (field === 'meterStartA') {
                    fieldElement = dataSetElement.querySelector(`[name="meterStartA_${setNumber}"]`);
                } else if (field === 'meterEndA') {
                    fieldElement = dataSetElement.querySelector(`[name="meterEndA_${setNumber}"]`);
                }
                
                if (fieldElement) {
                    fieldElement.classList.add('error-field');
                    if (!firstErrorField) {
                        firstErrorField = fieldElement;
                    }
                }
            });
            
            // Trigger animation after a small delay to ensure CSS is applied
            requestAnimationFrame(() => {
                document.querySelectorAll('.error-field').forEach(el => {
                    el.classList.add('shake-animation');
                });
            });
            
            // Scroll to first error and focus
            if (firstErrorField) {
                firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                setTimeout(() => {
                    firstErrorField.focus();
                }, 500);
            }
        }

        // Data Submission Functions
        async function submitData() {
            console.log('🚀 เริ่มต้นการส่งข้อมูล');
            
            const allData = collectAllData();
            if (!allData || allData.length === 0) {
                showNotification('ไม่พบข้อมูลที่จะส่ง', 'error');
                return;
            }
            
            // Validate all required fields
            const validation = validateAllData(allData);
            if (!validation.isValid) {
                highlightEmptyFields(validation.emptyFields);
                return;
            }
            
            // Save data for recovery before submission
            saveDataForRecovery(allData);
            
            showLoading();
            updateProgressStep(1);
            updateLoadingStatus('กำลังเตรียมข้อมูล...');
            
            const payload = {
                action: 'saveData',
                data: {
                    title: "รายงานแผนกผลิต 2 สำหรับ กะ B",
                    timestamp: new Date().toISOString(),
                    totalSets: allData.length,
                    data: allData
                },
                sheetId: API_CONFIG.sheetId,
                folderId: API_CONFIG.folderId,
                timestamp: new Date().toISOString()
            };
            
            try {
                await submitWithRetry(payload, 3, 1);
            } catch (error) {
                console.error('❌ การส่งข้อมูลล้มเหลว:', error);
                hideLoading();
                showNotification('การส่งข้อมูลล้มเหลว กรุณาลองใหม่อีกครั้ง', 'error');
            }
        }

        const PD2_SUBMIT_CFG = {
            minStep5VisibleMs: 90,
            preSendPaintMs: 50,
            preSendPaintMs: 50,
            attemptTimeoutMs: 10000,
            baseBackoffMs: 450,
            backoffFactor: 2,
            jitterMs: 150
        };
        if (!window.PD2PerfLog) window.PD2PerfLog = [];
        const perfStartB = () => performance.now();
        async function submitWithRetry(data, maxRetries, currentAttempt, useBackup = false, t0) {
            if (!t0) t0 = perfStartB();
            const mark = (phase, extra) => { try { window.PD2PerfLog.push({ module:'SHIFT_B', phase, t: performance.now(), dt:+(performance.now()-t0).toFixed(1), ...(extra||{}) }); } catch(_){} };
            console.log(`🔄 ความพยายามที่ ${currentAttempt}/${maxRetries}${useBackup ? ' (ใช้ backup)' : ''}`);
            updateProgressStep(2); updateLoadingStatus('กำลังตรวจสอบข้อมูล...');
            if (!SYSTEM_HEALTH.isOnline) throw new Error('ไม่มีการเชื่อมต่ออินเทอร์เน็ต');
            await new Promise(r => setTimeout(r, 60));
            updateProgressStep(3); updateLoadingStatus('กำลังเชื่อมต่อเซิร์ฟเวอร์...');
            let endpoint = API_CONFIG.endpoint;
            if (useBackup && API_CONFIG.backupEndpoints.length > 0) {
                const backupIndex = (currentAttempt - 1) % API_CONFIG.backupEndpoints.length;
                endpoint = API_CONFIG.backupEndpoints[backupIndex];
                console.log(`🔄 ใช้ backup endpoint: ${endpoint}`);
            }
            try {
                const submissionId = (self.crypto && crypto.randomUUID ? crypto.randomUUID() : 'sub-' + Date.now() + '-' + Math.random().toString(16).slice(2));
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), PD2_SUBMIT_CFG.attemptTimeoutMs);
                const payload = { ...data, submissionId, systemInfo: { userAgent: navigator.userAgent, timestamp: new Date().toISOString(), attempt: currentAttempt, endpoint } };
                // แสดงขั้นตอนที่ 4 ชัดเจน ก่อนเริ่มส่งข้อมูล
                updateProgressStep(4); updateLoadingStatus('กำลังส่งข้อมูล...');
                await new Promise(r => setTimeout(r, PD2_SUBMIT_CFG.preSendPaintMs));
                mark('send');
                // Simple request (หลบ preflight)
                const response = await fetch(endpoint, { method: 'POST', headers: { 'Content-Type': 'text/plain;charset=utf-8' }, body: JSON.stringify(payload), signal: controller.signal, cache: 'no-store', keepalive: true });
                clearTimeout(timeoutId);
                let ok = response.ok; let txt=''; let json=null;
                try { txt = await response.text(); if (txt) { try { json = JSON.parse(txt); } catch(_){} } } catch(_){}
                const logicalSuccess = json && (json.success === true || json.status === 'ok');
                if (!ok || !logicalSuccess) {
                    const pending = { savedAt: new Date().toISOString(), submissionId, endpoint, httpStatus: response.status, ok, logicalSuccess, bodySample: (txt||'').slice(0,500), payload };
                    LS.set('pendingSubmission', JSON.stringify(pending));
                    throw new Error('การยืนยันผลล้มเหลว HTTP:' + response.status + ' successFlag:' + logicalSuccess);
                }
                updateProgressStep(5); updateLoadingStatus('ยืนยันการบันทึก...');
                mark('step5');
                const s5At = performance.now();
                const need = PD2_SUBMIT_CFG.minStep5VisibleMs - (performance.now() - s5At);
                if (need > 10) await new Promise(r => setTimeout(r, need));
                LS.remove('pendingSubmission');
                SYSTEM_HEALTH.saveFailureCount = 0; SYSTEM_HEALTH.lastSaveTime = new Date();
                const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                hideLoading();
                showSuccessModal(totalRows);
                console.log('✅ ส่งข้อมูลสำเร็จ', { submissionId, totalRows, response: json });
            } catch (error) {
                const isLikelyCors = (error instanceof TypeError) || /fetch|network|cors/i.test(error.message || '');
        if (currentAttempt === 1 && isLikelyCors) {
                    try {
                        console.warn('⚠️ Simple POST ล้มเหลว อาจติด CORS -> ลอง JSONP');
                        // อัปเดตขั้นตอนเป็นการส่งข้อมูล ก่อนเริ่ม JSONP
            updateProgressStep(4); updateLoadingStatus('กำลังส่งข้อมูล...');
            await new Promise(r => setTimeout(r, PD2_SUBMIT_CFG.preSendPaintMs));
                        const jsonpResult = await jsonpFallback(data, endpoint);
                        if (jsonpResult && jsonpResult.success) {
                            const totalRows = (data && data.data && data.data.data) ? data.data.data.length : 0;
                updateProgressStep(5); updateLoadingStatus('ยืนยันการบันทึก...');
                const s5At2 = performance.now();
                const need2 = PD2_SUBMIT_CFG.minStep5VisibleMs - (performance.now() - s5At2);
                if (need2 > 10) await new Promise(r => setTimeout(r, need2));
                            hideLoading();
                            showNotification('บันทึกสำเร็จ '+ totalRows +' รายการ', 'orange');
                            SYSTEM_HEALTH.saveFailureCount = 0; LS.remove('pendingSubmission');
                            return;
                        }
                    } catch (jsonpErr) { console.error('❌ JSONP fallback ล้มเหลว:', jsonpErr); }
                }
                console.error(`❌ ความพยายามที่ ${currentAttempt} ล้มเหลว:`, error);
                ERROR_LOG.log(error, `Submit attempt ${currentAttempt}`); SYSTEM_HEALTH.saveFailureCount++;
                if (currentAttempt < maxRetries) {
                    updateLoadingStatus(`กำลังลองใหม่... (${currentAttempt + 1}/${maxRetries})`);
            const base = PD2_SUBMIT_CFG.baseBackoffMs * Math.pow(PD2_SUBMIT_CFG.backoffFactor, currentAttempt - 1);
            const jitter = Math.random() * PD2_SUBMIT_CFG.jitterMs;
            const delay = Math.min(base + jitter, 5000);
            await new Promise(r => setTimeout(r, delay));
            const shouldUseBackup = currentAttempt >= 2; return submitWithRetry(data, maxRetries, currentAttempt + 1, shouldUseBackup, t0);
                } else {
                    if (SYSTEM_HEALTH.saveFailureCount >= SYSTEM_HEALTH.maxFailures) showNotification('ระบบมีปัญหาการส่งข้อมูลซ้ำๆ กรุณาติดต่อผู้ดูแลระบบ', 'error');
                    try { if (LS.get('pendingSubmission')) showNotification('ไม่สามารถยืนยันผล เซฟ pending รอส่งใหม่', 'warning'); } catch(_){}
                    throw error;
                }
            }
        }

        // JSONP fallback helper
        function jsonpFallback(originalPayload, endpoint) {
            return new Promise((resolve, reject) => {
                try {
                    if (!originalPayload || originalPayload.action !== 'saveData') return reject(new Error('JSONP รองรับเฉพาะ saveData'));
                    const minimal = { action: 'saveData', data: originalPayload.data };
                    const jsonStr = JSON.stringify(minimal);
                    const encoded = encodeURIComponent(jsonStr);
                    if (encoded.length > 7000) return reject(new Error('ข้อมูลยาวเกินไปสำหรับ JSONP'));
                    const cbName = '__jsonpCB_' + Date.now() + '_' + Math.random().toString(16).slice(2);
                    const url = endpoint + '?action=saveData&data=' + encoded + '&callback=' + cbName;
                    const script = document.createElement('script');
                    let timeoutId;
                    window[cbName] = function(resp){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); resolve(resp); };
                    script.onerror = function(){ clearTimeout(timeoutId); try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP script load error')); };
                    timeoutId = setTimeout(() => { try { delete window[cbName]; } catch(_){} script.remove(); reject(new Error('JSONP timeout')); }, 15000);
                    script.src = url; document.head.appendChild(script);
                } catch(err) { reject(err); }
            });
        }

        // Collect All Data
    function collectAllData() {
            const allData = [];
            const dataSets = document.querySelectorAll('.data-set');
            
            dataSets.forEach((dataSet, index) => {
                const setNumber = (dataSet.getAttribute('data-set') || (index + 1)).toString();
                
                // Machine: ใช้ manual input ถ้า trim แล้วมีค่า, ไม่เช่นนั้นใช้ select
                const machSelVal = dataSet.querySelector(`[name="machine_${setNumber}"]`)?.value || '';
                const machManualVal = dataSet.querySelector(`[name="machineManual_${setNumber}"]`)?.value || '';
                const machManualTrimmed = machManualVal.trim();
                const machineValue = machManualTrimmed ? machManualTrimmed : machSelVal;
                
                // Employee A: ใช้ manual input ถ้า trim แล้วมีค่า, ไม่เช่นนั้นใช้ select
                const empSelVal = dataSet.querySelector(`[name="employeeA_${setNumber}"]`)?.value || '';
                const empManualVal = dataSet.querySelector(`[name="employeeAManual_${setNumber}"]`)?.value || '';
                const empManualTrimmed = empManualVal.trim();
                let employeeAValue = empSelVal;
                if (empManualTrimmed) {
                    // ถ้ากรอกเองแบบ "ID - ชื่อ" ให้แตก ID ออกมา
                    const idFromManual = empManualTrimmed.split(' - ')[0].trim();
                    employeeAValue = idFromManual || empManualTrimmed;
                }

                // Fabric Size: ใช้ manual input ถ้า trim แล้วมีค่า, ไม่เช่นนั้นใช้ select
                const fabSelVal = dataSet.querySelector(`[name="fabricSize_${setNumber}"]`)?.value || '';
                const fabManualVal = dataSet.querySelector(`[name="fabricSizeManual_${setNumber}"]`)?.value || '';
                const fabManualTrimmed = fabManualVal.trim();
                const fabricSizeValue = fabManualTrimmed ? fabManualTrimmed : fabSelVal;
                const setData = {
                    setNumber: Number(setNumber),
                    date: dataSet.querySelector(`[name="date_${setNumber}"]`)?.value || '',
            machine: machineValue,
                    employeeA: employeeAValue,
                    fabricSize: fabricSizeValue,
                    lotNo: dataSet.querySelector(`[name="lotNo_${setNumber}"]`)?.value || '',
                    orderNo: dataSet.querySelector(`[name="orderNo_${setNumber}"]`)?.value || '',
                    productionA: dataSet.querySelector(`[name="productionA_${setNumber}"]`)?.value || '',
                    speedA: dataSet.querySelector(`[name="speedA_${setNumber}"]`)?.value || '',
                    efficiencyA: dataSet.querySelector(`[name="efficiencyA_${setNumber}"]`)?.value || '',
                    meterStartA: dataSet.querySelector(`[name="meterStartA_${setNumber}"]`)?.value || '',
                    meterEndA: dataSet.querySelector(`[name="meterEndA_${setNumber}"]`)?.value || '',
                    lengthA: dataSet.querySelector(`[name="lengthA_${setNumber}"]`)?.value || '',
                    wageB: dataSet.querySelector(`[name="wageB_${setNumber}"]`)?.value || ''
                };
                
                allData.push(setData);
            });
            
            return allData;
        }

        // PNG Export (Shift B): Renders selected fields from all data sets to a single image
        function exportPNG() {
            try {
                const data = collectAllData();
                if (!data || data.length === 0) {
                    try { showNotification('ไม่มีข้อมูลสำหรับสร้างรูปภาพ', 'warning'); } catch(_) { alert('ไม่มีข้อมูลสำหรับสร้างรูปภาพ'); }
                    return;
                }

                // Prepare text lines
                const now = new Date();
                const headerTitle = 'รายงานกะ B - บันทึกเป็น PNG';
                const headerTime = 'สร้างเมื่อ: ' + now.toLocaleString('th-TH');
                const headerCount = 'จำนวนชุดข้อมูล: ' + data.length;
                const rawLines = [headerTitle, headerTime, headerCount, ''];

                data.forEach((set, idx) => {
                    rawLines.push('ชุดข้อมูลที่ ' + (idx + 1));
                    rawLines.push('วันที่: ' + (set.date || ''));
                    rawLines.push('เครื่องทอ NO: ' + (set.machine || ''));
                    // Note: file uses employeeA for B module selection; we output as กะ B label to match UI
                    rawLines.push('ชื่อพนักงานทอ กะ B: ' + (set.employeeA || ''));
                    rawLines.push('ขนาดหน้าผ้า: ' + (set.fabricSize || ''));
                    rawLines.push('กะ B: เริ่มงาน: ' + (set.meterStartA || ''));
                    rawLines.push('กะ B: เลิกงาน: ' + (set.meterEndA || ''));
                    rawLines.push('ความยาวตัดม้วน (เมตร): ' + (set.lengthA || ''));
                    rawLines.push('ค่าแรงพนักงาน (กะ B): ' + (set.wageB || ''));
                    rawLines.push('');
                });

                // Canvas sizing and wrapping
                const padding = 32;
                const width = 1080;
                const fontSize = 28;
                const lineHeight = Math.round(fontSize * 1.4);
                const fontFamily = "Kanit, Tahoma, sans-serif";

                const measureCanvas = document.createElement('canvas');
                const mctx = measureCanvas.getContext('2d');
                mctx.font = `${fontSize}px ${fontFamily}`;
                const maxTextWidth = width - padding * 2;

                const wrapText = (text) => {
                    const words = (text || '').toString().split(/\s+/);
                    const lines = [];
                    let line = '';
                    for (let i = 0; i < words.length; i++) {
                        const testLine = line ? (line + ' ' + words[i]) : words[i];
                        const metrics = mctx.measureText(testLine);
                        if (metrics.width > maxTextWidth && line) {
                            lines.push(line);
                            line = words[i];
                        } else {
                            line = testLine;
                        }
                    }
                    if (line) lines.push(line);
                    for (let i = 0; i < lines.length; i++) {
                        if (mctx.measureText(lines[i]).width > maxTextWidth) {
                            const broken = [];
                            let current = lines[i];
                            while (mctx.measureText(current).width > maxTextWidth && current.length > 1) {
                                let lo = 1, hi = current.length, cut = 1;
                                while (lo <= hi) {
                                    const mid = (lo + hi) >> 1;
                                    const substr = current.slice(0, mid);
                                    if (mctx.measureText(substr).width <= maxTextWidth) { cut = mid; lo = mid + 1; } else { hi = mid - 1; }
                                }
                                broken.push(current.slice(0, cut));
                                current = current.slice(cut);
                            }
                            if (current) broken.push(current);
                            lines.splice(i, 1, ...broken);
                            i += broken.length - 1;
                        }
                    }
                    return lines;
                };

                const finalLines = [];
                rawLines.forEach(line => {
                    const wrapped = wrapText(line);
                    if (wrapped.length === 0) finalLines.push('');
                    else finalLines.push(...wrapped);
                });

                const height = padding * 2 + finalLines.length * lineHeight;
                const canvas = document.createElement('canvas');
                canvas.width = width;
                canvas.height = Math.max(height, padding * 2 + lineHeight);
                const ctx = canvas.getContext('2d');

                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                ctx.fillStyle = '#111827';
                ctx.font = `${fontSize}px ${fontFamily}`;
                ctx.textBaseline = 'top';

                let y = padding;
                const x = padding;
                finalLines.forEach((ln, i) => {
                    if (/^ชุดข้อมูลที่\s+\d+/.test(ln)) {
                        ctx.font = `bold ${fontSize}px ${fontFamily}`;
                    } else if (i <= 2) {
                        ctx.font = `600 ${fontSize}px ${fontFamily}`;
                    } else {
                        ctx.font = `${fontSize}px ${fontFamily}`;
                    }
                    ctx.fillText(ln, x, y);
                    y += lineHeight;
                });

                const pad = (n) => (n < 10 ? '0' + n : '' + n);
                const yyyy = now.getFullYear();
                const mm = pad(now.getMonth() + 1);
                const dd = pad(now.getDate());
                const hh = pad(now.getHours());
                const mi = pad(now.getMinutes());
                const ss = pad(now.getSeconds());
                const filename = `PD2_ShiftB_${yyyy}${mm}${dd}_${hh}${mi}${ss}.png`;

                // Use blob-based save to avoid opening new tabs
                canvas.toBlob(async (blob) => {
                    if (!blob) { try { showNotification('ไม่สามารถสร้างไฟล์ PNG', 'error'); } catch(_) {}; return; }

                    // 1) File System Access API
                    if (window.showSaveFilePicker) {
                        try {
                            const handle = await window.showSaveFilePicker({
                                suggestedName: filename,
                                types: [{ description: 'PNG Image', accept: { 'image/png': ['.png'] } }]
                            });
                            const writable = await handle.createWritable();
                            await writable.write(blob);
                            await writable.close();
                            try { showNotification('บันทึกไฟล์สำเร็จ', 'blue'); } catch(_) {}
                            return;
                        } catch(_){}
                    }

                    // 2) Web Share API with files (mobile)
                    try {
                        const file = new File([blob], filename, { type: 'image/png' });
                        if (navigator.canShare && navigator.canShare({ files: [file] })) {
                            await navigator.share({ files: [file], title: 'PD2 Export', text: 'PD2 Shift B' });
                            try { showNotification('เปิดเมนูแชร์ไฟล์แล้ว', 'blue'); } catch(_) {}
                            return;
                        }
                    } catch(_){}

                    // 3) Anchor + object URL fallback (same tab)
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    a.target = '_self';
                    a.rel = 'noopener';
                    a.style.display = 'none';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => { URL.revokeObjectURL(url); a.remove(); }, 1500);
                }, 'image/png');
            } catch (err) {
                console.error('❌ ไม่สามารถสร้าง PNG ได้:', err);
                try { showNotification('ไม่สามารถสร้าง PNG ได้', 'error'); } catch(_) { alert('ไม่สามารถสร้าง PNG ได้'); }
            }
        }

        // Storage namespace helper (safe for combined UI)
        const SHIFT_ID = 'B';
        const LS = {
            _p: function(k){ return `PD2_SHIFT_${SHIFT_ID}_${k}`; },
            get: function(k){ try { return localStorage.getItem(this._p(k)); } catch(e){ return null; } },
            set: function(k,v){ try { localStorage.setItem(this._p(k), v); } catch(e){} },
            remove: function(k){ try { localStorage.removeItem(this._p(k)); } catch(e){} }
        };

        // Listen for parent frame commands when embedded
        try {
            window.addEventListener('message', function(ev){
                var msg = ev && ev.data;
                if (!msg || msg.shift && msg.shift !== SHIFT_ID) return; // ignore others
                if (msg && msg.cmd === 'save') { saveToLocalStorage(true); window.parent.postMessage({shift:SHIFT_ID, event:'saved'}, '*'); }
                if (msg && msg.cmd === 'load') { loadFromLocalStorage(); window.parent.postMessage({shift:SHIFT_ID, event:'loaded'}, '*'); }
                if (msg && msg.cmd === 'clear') { clearLocalStorage(); window.parent.postMessage({shift:SHIFT_ID, event:'cleared'}, '*'); }
            }, false);
        } catch(e){}

        // Storage Functions - ปรับปรุงให้แข็งแกร่งขึ้น
        function saveToLocalStorage() {
            const saveStartTime = performance.now();
            
            try {
                const allData = collectAllData();
                
                // Validate data before saving
                if (!allData || allData.length === 0) {
                    console.warn('⚠️ ไม่มีข้อมูลที่จะบันทึก');
                    return;
                }
                
                const storageData = {
                    version: '2.0', // เพิ่ม version tracking
                    timestamp: new Date().toISOString(),
                    dataSetCount: dataSetCount,
                    data: allData,
                    // custom lists removed (session-only for new entries)
                    systemHealth: {
                        saveTime: saveStartTime,
                        errorCount: SYSTEM_HEALTH.performanceMetrics.errorCount,
                        lastSaveTime: SYSTEM_HEALTH.lastSaveTime
                    }
                };
                
                // Check storage size before saving
                const dataSize = JSON.stringify(storageData).length;
                const maxSize = 5 * 1024 * 1024; // 5MB limit
                
                if (dataSize > maxSize) {
                    // Clean old data if size is too large
                    cleanOldStorageData();
                }
                
                // Create backup before overwriting (namespaced)
                const existingData = LS.get('productionData');
                if (existingData) {
                    LS.set('productionDataBackup', existingData);
                }
                
                LS.set('productionData', JSON.stringify(storageData));
                
                const saveTime = performance.now() - saveStartTime;
                SYSTEM_HEALTH.performanceMetrics.saveTime = saveTime;
                SYSTEM_HEALTH.lastSaveTime = new Date();
                
                console.log(`💾 บันทึกข้อมูลแล้ว (${saveTime.toFixed(2)}ms, ${(dataSize/1024).toFixed(2)}KB)`);
                
                // Only show notification if manually triggered
                if (arguments.length > 0 && arguments[0] === true) {
                    showNotification('บันทึกข้อมูลเรียบร้อยแล้ว', 'purple');
                }
                
            } catch (error) {
                ERROR_LOG.log(error, 'Save to localStorage failed');
                console.error('❌ ไม่สามารถบันทึกข้อมูลได้:', error);
                
                // Try to recover from backup
                if (error.name === 'QuotaExceededError') {
                    showNotification('พื้นที่จัดเก็บข้อมูลเต็ม กำลังล้างข้อมูลเก่า...', 'warning');
                    cleanOldStorageData();
                    
                    // Try saving again
                    try {
                        LS.set('productionData', JSON.stringify(storageData));
                        showNotification('บันทึกข้อมูลเรียบร้อยแล้ว', 'success');
                    } catch (retryError) {
                        showNotification('ไม่สามารถบันทึกข้อมูลได้ กรุณาล้างข้อมูลเก่า', 'error');
                    }
                } else {
                    showNotification('ไม่สามารถบันทึกข้อมูลได้', 'error');
                }
            }
        }
        
        function cleanOldStorageData() {
            try {
                // Remove old error logs (namespaced)
                const errorLog = LS.get('errorLog');
                if (errorLog) {
                    const logs = JSON.parse(errorLog);
                    const recentLogs = logs.slice(0, 50); // Keep only 50 recent entries
                    LS.set('errorLog', JSON.stringify(recentLogs));
                }
                
                // Remove old backup data
                LS.remove('productionDataBackup');
                
                // Remove other temporary data (global keys still checked)
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.startsWith('temp_') || key.startsWith('old_') || key.includes('_PD2_SHIFT_B_'))) {
                        keysToRemove.push(key);
                    }
                }
                
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                console.log(`🧹 ล้างข้อมูลเก่าแล้ว (${keysToRemove.length} รายการ)`);
                
            } catch (error) {
                ERROR_LOG.log(error, 'Clean old storage data failed');
                console.error('❌ ไม่สามารถล้างข้อมูลเก่าได้:', error);
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = LS.get('productionData');
                if (!stored) {
                    console.log('✅ ไม่พบข้อมูลที่บันทึกไว้');
                    return;
                }
                
                const storageData = JSON.parse(stored);
                
                // ไม่กู้คืน custom lists เพื่อป้องกันข้อมูลซ้ำ และให้หายเมื่อรีเฟรช
                
                // Clear existing data sets
                document.getElementById('dataContainer').innerHTML = '';
                
                // Restore data sets
                dataSetCount = storageData.dataSetCount || 1;
                for (let i = 1; i <= dataSetCount; i++) {
                    const container = document.getElementById('dataContainer');
                    const newDataSet = document.createElement('div');
                    newDataSet.innerHTML = generateDataSet(i);
                    const el = newDataSet.firstElementChild;
                    if (el) {
                        try { el.style.opacity = '0'; el.style.transition = 'opacity 180ms ease-out'; el.style.visibility = 'hidden'; } catch(_){}
                        container.appendChild(el);
                        console.log('PD2: restored dataset', i, el);
                        requestAnimationFrame(() => { try { el.style.visibility = 'visible'; void el.offsetWidth; el.style.opacity = '1'; } catch(_){} });
                    }
                }
                
                // Fill data
                if (storageData.data) {
                    storageData.data.forEach((setData, index) => {
                        const setNumber = index + 1;
                        const dataSet = document.querySelector(`[data-set="${setNumber}"]`);
                        if (dataSet) {
                            Object.keys(setData).forEach(key => {
                                if (key !== 'setNumber') {
                                    const input = dataSet.querySelector(`[name="${key}_${setNumber}"]`);
                                    if (input && !input.readOnly) {
                                        input.value = setData[key];
                                    }
                                }
                            });
                            // Ensure wage recompute after restore
                            try { window.PD2_WAGE_B && window.PD2_WAGE_B.updateWageBForSet(setNumber); } catch(_){ }

                            const empVal = setData.employeeA || '';
                            if (empVal) {
                                const empSel = dataSet.querySelector(`[name="employeeA_${setNumber}"]`);
                                if (empSel) {
                                    const optionFound = Array.from(empSel.options).some(o => o.value === empVal);
                                    if (!optionFound) {
                                        const empManual = dataSet.querySelector(`[name="employeeAManual_${setNumber}"]`);
                                        if (empManual) {
                                            const emp = employees.find(e => e.id === empVal);
                                            empManual.value = emp ? `${emp.id} - ${emp.name}` : empVal;
                                            empSel.value = '';
                                        }
                                    }
                                }
                            }

                            const fabVal = setData.fabricSize || '';
                            if (fabVal) {
                                const fabSel = dataSet.querySelector(`[name="fabricSize_${setNumber}"]`);
                                if (fabSel) {
                                    const optionFound = Array.from(fabSel.options).some(o => o.value === fabVal);
                                    if (!optionFound) {
                                        const fabManual = dataSet.querySelector(`[name="fabricSizeManual_${setNumber}"]`);
                                        if (fabManual) {
                                            fabManual.value = fabVal;
                                            fabSel.value = '';
                                        }
                                    }
                                }
                            }

                            // คืนค่าของเครื่องทอ: ถ้าไม่พบในรายการ ให้ไปไว้ช่องกรอกเอง
                            const machVal = setData.machine || '';
                            if (machVal) {
                                const machSel = dataSet.querySelector(`[name="machine_${setNumber}"]`);
                                if (machSel) {
                                    const optionFound = Array.from(machSel.options).some(o => o.value === machVal);
                                    if (!optionFound) {
                                        const machManual = dataSet.querySelector(`[name="machineManual_${setNumber}"]`);
                                        if (machManual) {
                                            machManual.value = machVal;
                                            machSel.value = '';
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
                
                updateDataSetCount();
                setupSelectHandlers();
                refreshAllSelects();
                try { window.PD2_WAGE_B && window.PD2_WAGE_B.bindWageBForAllSets(); } catch(_){ }
                
                console.log('📂 โหลดข้อมูลเรียบร้อยแล้ว');
                // ลบ notification ที่เด้งขึ้นทุกครั้ง - ไม่จำเป็น
                // showNotification('โหลดข้อมูลเรียบร้อยแล้ว', 'success');
                
            } catch (error) {
                console.error('❌ ไม่สามารถโหลดข้อมูลได้:', error);
                showNotification('ไม่สามารถโหลดข้อมูลได้', 'error');
            }
        }

        // Reset all data sets to a single fresh set
        function resetToSingleDataSet() {
            try {
                const ok = confirm('ยืนยันการรีเซ็ตการบันทึกข้อมูล ให้เริ่มใหม่ด้วย 1 ชุดข้อมูลหรือไม่?');
                if (!ok) return;

                // Clear stored data for this shift (B)
                LS.remove('productionData');
                LS.remove('pendingSubmission');

                // Rebuild DOM with only one fresh data set
                const container = document.getElementById('dataContainer');
                if (!container) throw new Error('ไม่พบ dataContainer');
                container.innerHTML = '';
                const wrapper = document.createElement('div');
                wrapper.innerHTML = generateDataSet(1);
                const child = wrapper.firstElementChild;
                if (child) {
                    try { child.style.opacity = '0'; child.style.transition = 'opacity 180ms ease-out'; child.style.visibility = 'hidden'; } catch(_){}
                    container.appendChild(child);
                    console.log('PD2: reset to single dataset appended', child);
                    requestAnimationFrame(() => { try { child.style.visibility = 'visible'; void child.offsetWidth; child.style.opacity = '1'; } catch(_){} });
                }

                // Reset counters and UI
                dataSetCount = 1;
                updateDataSetCount();
                setupSelectHandlers();
                refreshAllSelects && refreshAllSelects();
                try { window.PD2_WAGE_B && window.PD2_WAGE_B.bindWageBForAllSets(); } catch(_){ }

                // Persist the fresh state
                saveToLocalStorage();

                // UX
                window.scrollTo({ top: 0, behavior: 'smooth' });
                showNotification('รีเซ็ตสำเร็จ เหลือ 1 ชุดข้อมูล', 'success');
            } catch (error) {
                console.error('❌ ไม่สามารถรีเซ็ตชุดข้อมูลได้:', error);
                showNotification('ไม่สามารถรีเซ็ตชุดข้อมูลได้', 'error');
            }
        }

        // Recovery System
        function saveDataForRecovery(data) {
            try {
                const recoveryData = {
                    timestamp: new Date().toISOString(),
                    data: data
                };
                LS.set('pendingSubmission', JSON.stringify(recoveryData));
                console.log('🔄 บันทึกข้อมูลสำหรับกู้คืน');
            } catch (error) {
                console.error('❌ ไม่สามารถบันทึกข้อมูลสำหรับกู้คืนได้:', error);
            }
        }

        function checkForPendingSubmissions() {
            try {
                const pending = LS.get('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    const timestamp = new Date(recoveryData.timestamp);
                    const now = new Date();
                    const hoursDiff = (now - timestamp) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 1) {
                        // Auto cleanup old data
                        LS.remove('pendingSubmission');
                        console.log('🧹 ลบข้อมูลค้างส่งที่เก่าแล้ว');
                    } else {
                        // Show recovery modal
                        document.getElementById('recoveryModal').classList.remove('hidden');
                        console.log('🔄 พบข้อมูลค้างส่ง');
                    }
                }
            } catch (error) {
                console.error('❌ ไม่สามารถตรวจสอบข้อมูลค้างส่งได้:', error);
            }
        }

        function retryPendingSubmission() {
            try {
                const pending = LS.get('pendingSubmission');
                if (pending) {
                    const recoveryData = JSON.parse(pending);
                    document.getElementById('recoveryModal').classList.add('hidden');
                    
                    const payload = {
                        action: 'saveData',
                        data: {
                            title: "รายงานแผนกผลิต 2 สำหรับ กะ B (กู้คืน)",
                            timestamp: recoveryData.timestamp,
                            totalSets: recoveryData.data.length,
                            data: recoveryData.data
                        },
                        sheetId: API_CONFIG.sheetId,
                        folderId: API_CONFIG.folderId,
                        timestamp: new Date().toISOString()
                    };
                    
                    showLoading();
                    submitWithRetry(payload, 3, 1);
                }
            } catch (error) {
                console.error('❌ ไม่สามารถลองส่งข้อมูลใหม่ได้:', error);
                showNotification('ไม่สามารถลองส่งข้อมูลใหม่ได้', 'error');
            }
        }

        function discardPendingSubmission() {
            LS.remove('pendingSubmission');
            document.getElementById('recoveryModal').classList.add('hidden');
            showNotification('ยกเลิกข้อมูลค้างส่งแล้ว', 'success');
        }

        // UI Management Functions
        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
            // Reset progress steps
            for (let i = 1; i <= 5; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active', 'completed');
            }
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function updateLoadingStatus(message) {
            document.getElementById('loadingStatus').textContent = message;
        }

        function updateProgressStep(stepNumber) {
            // Mark previous steps as completed
            for (let i = 1; i < stepNumber; i++) {
                const step = document.getElementById(`step${i}`);
                step.classList.remove('active');
                step.classList.add('completed');
            }
            
            // Mark current step as active
            const currentStep = document.getElementById(`step${stepNumber}`);
            currentStep.classList.add('active');
            currentStep.classList.remove('completed');
        }

    // ช่วยให้ UI มีเวลาวาดผลลัพธ์ก่อนดำเนินการต่อ
    function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
    function _nextFrame() { return new Promise(resolve => requestAnimationFrame(() => resolve())); }
    async function flushUI() { try { await _nextFrame(); await _nextFrame(); } catch(_) {} }
                // load shared PD2 notification module (safe JS loader)
                (function(){
                    if (window.PD2Notify) return;
                    try {
                        const s = document.createElement('script');
                        s.src = '../pd2-notify.js';
                        s.async = false; // load synchronously so handlers can use it immediately
                        s.addEventListener('error', () => { try { console.warn('pd2-notify failed to load'); } catch(_){} });
                        document.head.appendChild(s);
                    } catch(_){}
                })();

                function showNotification(message, type = 'info') {
                    // Prefer parent-level notifier when available; fallback to local loader.
                    try {
                        if (window.parent && window.parent !== window && window.parent.PD2Notify) {
                            return window.parent.PD2Notify(message, type);
                        }
                        if (window.PD2Notify) return window.PD2Notify(message, type);

                        // If loader not present, inject it (only once).
                        if (!document.getElementById('pd2-notify-loader')) {
                            const s = document.createElement('script');
                            s.id = 'pd2-notify-loader';
                            s.src = '../pd2-notify.js';
                            s.defer = true;
                            s.onload = () => {
                                try {
                                    const fn = (window.parent && window.parent.PD2Notify) ? window.parent.PD2Notify : window.PD2Notify;
                                    if (fn) fn(message, type);
                                } catch(e){ console.error('PD2Notify onload handler error', e); }
                            };
                            s.onerror = () => { console.error('Failed to load shared pd2-notify.js'); };
                            document.head.appendChild(s);
                        } else {
                            // Loader present but module may not be initialized yet. Poll briefly.
                            const start = Date.now();
                            const interval = setInterval(() => {
                                const fn = (window.parent && window.parent.PD2Notify) ? window.parent.PD2Notify : window.PD2Notify;
                                if (fn) { clearInterval(interval); return fn(message, type); }
                                if (Date.now() - start > 5000) clearInterval(interval);
                            }, 100);
                        }
                    } catch (err) {
                        console.error('showNotification error', err);
                    }
                }

        // System Health Check Function


        // Note: First data set is already created in the main DOMContentLoaded event
        
        // กล่องคำแนะนำแบบแสดงทันที (custom autocomplete) — เหมือนของกะ A
        function attachInstantSuggestions(inputEl, optionsProvider) {
            if (!inputEl || inputEl.dataset.suggestBound) return;
            inputEl.dataset.suggestBound = '1';

            // Guard: ensure any native <select> dropdown gets closed before interacting with our suggestions
            function ensureClosedNativeDropdown() {
                const ae = document.activeElement;
                if (ae && ae.tagName === 'SELECT') {
                    try { ae.blur(); } catch (_) {}
                }
            }

            const panel = document.createElement('div');
            panel.className = 'instant-suggestions hidden';
            Object.assign(panel.style, {
                position: 'fixed',
                zIndex: 9999,
                background: '#ffffff',
                border: '1px solid #d1d5db',
                borderRadius: '0.5rem',
                boxShadow: '0 8px 16px rgba(0,0,0,0.12)',
                maxHeight: '240px',
                overflowY: 'auto',
                minWidth: '200px',
                fontSize: '14px'
            });
            document.body.appendChild(panel);

            let items = [];
            let highlightIndex = -1;
            let visible = false;

            function positionPanel() {
                if (!visible) return;
                const rect = inputEl.getBoundingClientRect();
                panel.style.left = `${Math.round(rect.left)}px`;
                panel.style.top = `${Math.round(rect.bottom + 4)}px`;
                panel.style.width = `${Math.round(rect.width)}px`;
            }

            function showPanel() {
                if (panel.classList.contains('hidden')) panel.classList.remove('hidden');
                visible = true;
                positionPanel();
            }

            function hidePanel() {
                if (!panel.classList.contains('hidden')) panel.classList.add('hidden');
                visible = false;
                highlightIndex = -1;
            }

            function renderList(list) {
                panel.innerHTML = '';
                list.forEach((it, idx) => {
                    const row = document.createElement('div');
                    row.textContent = it.label;
                    Object.assign(row.style, {
                        padding: '8px 12px',
                        cursor: 'pointer',
                        background: idx === highlightIndex ? '#eff6ff' : '#ffffff',
                        color: '#111827'
                    });
                    row.addEventListener('mousemove', () => { highlightIndex = idx; renderList(list); });
                    row.addEventListener('mousedown', (ev) => { ev.preventDefault(); });
                    row.addEventListener('click', () => selectItem(it));
                    panel.appendChild(row);
                });
            }

            function updateList() {
                const q = (inputEl.value || '').toLowerCase();
                const all = (optionsProvider?.() || []);
                const filtered = q ? all.filter(o => o.key.includes(q)) : [];
                items = filtered.slice(0, 50);
                if (items.length > 0 && document.activeElement === inputEl) {
                    showPanel();
                    renderList(items);
                } else {
                    hidePanel();
                }
            }

            function selectItem(item) {
                inputEl.value = item.value;
                try { inputEl.dispatchEvent(new Event('input', { bubbles: true })); } catch(_) {}
                hidePanel();
            }

            function onKeyDown(e) {
                if (!visible) return;
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    highlightIndex = Math.min((highlightIndex < 0 ? 0 : highlightIndex + 1), items.length - 1);
                    renderList(items);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    highlightIndex = Math.max((highlightIndex < 0 ? 0 : highlightIndex - 1), 0);
                    renderList(items);
                } else if (e.key === 'Enter') {
                    if (highlightIndex >= 0 && items[highlightIndex]) {
                        e.preventDefault();
                        selectItem(items[highlightIndex]);
                    }
                } else if (e.key === 'Escape') {
                    hidePanel();
                }
            }

            inputEl.addEventListener('pointerdown', ensureClosedNativeDropdown, { capture: true });
            inputEl.addEventListener('input', updateList);
            inputEl.addEventListener('focus', ensureClosedNativeDropdown, { capture: true });
            inputEl.addEventListener('focus', updateList);
            inputEl.addEventListener('blur', () => setTimeout(hidePanel, 120));
            inputEl.addEventListener('keydown', onKeyDown);
            window.addEventListener('scroll', positionPanel, true);
            window.addEventListener('resize', positionPanel);
        }
    </script>
<script>
    try {
        const notifyReady = () => {
            try { if (window.parent && window.parent !== window) window.parent.postMessage({ type: 'PD2_READY' }, '*'); } catch(_){}
        };
        requestAnimationFrame(() => requestAnimationFrame(notifyReady));
    } catch(_){}
</script>
<script>
    // ============================================
    // Multi-Language System (i18n)
    // ============================================
    
    // Get current language from localStorage or default to Thai
    let currentLang = localStorage.getItem('pd2_language') || 'th';
    let isChangingLanguage = false; // Flag to prevent race condition
    let languageChangeTimeout = null; // Debounce timeout
    
    // Language display names
    const languageNames = {
        'th': 'ไทย',
        'en': 'English',
        'my': 'မြန်မာ',
        'mnw': 'မန်'
    };
    
    // Helper function to get translation with safety check
    function t(key) {
        // Safety: Check if translations object exists
        if (typeof translations === 'undefined') {
            console.warn('⚠️ Translations not loaded yet, using Thai fallback');
            return key; // Return key as fallback
        }
        return translations[currentLang]?.[key] || translations['th']?.[key] || key;
    }
    
    // Toggle language menu dropdown
    function toggleLanguageMenu() {
        const menu = document.getElementById('languageMenu');
        if (menu) menu.classList.toggle('hidden');
    }
    
    // Close language menu when clicking outside
    document.addEventListener('click', function(event) {
        const menu = document.getElementById('languageMenu');
        if (!menu) return;
        
        const button = event.target.closest('button[onclick="toggleLanguageMenu()"]');
        
        if (!button && !menu.contains(event.target)) {
            menu.classList.add('hidden');
        }
    });
    
    // Change language function
    function changeLanguage(lang) {
        // Prevent multiple simultaneous language changes
        if (isChangingLanguage) {
            console.warn('⚠️ Language change in progress, please wait...');
            return;
        }
        
        // Safety check
        if (typeof translations === 'undefined') {
            console.error('❌ Translations not loaded');
            alert('กรุณารอสักครู่... ระบบกำลังโหลดภาษา');
            return;
        }
        
        if (!translations[lang]) {
            console.error('Language not supported:', lang);
            return;
        }
        
        // Clear any pending language change
        if (languageChangeTimeout) {
            clearTimeout(languageChangeTimeout);
        }
        
        isChangingLanguage = true;
        
        try {
            currentLang = lang;
            localStorage.setItem('pd2_language', lang);
            
            // Update current language display immediately
            const langDisplay = document.getElementById('currentLanguage');
            if (langDisplay) langDisplay.textContent = languageNames[lang];
            
            // Hide menu immediately
            const menu = document.getElementById('languageMenu');
            if (menu) menu.classList.add('hidden');
            
            // Batch update UI with slight delay to ensure clean state
            languageChangeTimeout = setTimeout(() => {
                try {
                    // Update all static elements with data-i18n attribute
                    updatePageLanguage();
                    
                    // Regenerate all data sets to apply translation
                    regenerateAllDataSets();
                    
                    // Show notification
                    try {
                        if (window.PD2Notify) {
                            window.PD2Notify.show(
                                translations[lang]['lang.select'] || 'Language changed',
                                'success',
                                2000
                            );
                        }
                    } catch(e) {
                        console.log('Language changed to:', languageNames[lang]);
                    }
                } finally {
                    isChangingLanguage = false;
                }
            }, 50);
        } catch (error) {
            console.error('❌ Error changing language:', error);
            alert('เกิดข้อผิดพลาดในการเปลี่ยนภาษา กรุณาลองใหม่อีกครั้ง');
            isChangingLanguage = false;
        }
    }
    
    // Update all translatable elements on the page
    function updatePageLanguage() {
        try {
            const elements = document.querySelectorAll('[data-i18n]');
            const currentTranslations = translations[currentLang];
            
            if (!currentTranslations) {
                console.warn('⚠️ No translations for:', currentLang);
                return;
            }
            
            elements.forEach(element => {
                const key = element.getAttribute('data-i18n');
                if (currentTranslations[key]) {
                    // Update text content
                    element.textContent = currentTranslations[key];
                    
                    // Update placeholder if it's an input
                    if (element.tagName === 'INPUT' && element.placeholder) {
                        element.placeholder = currentTranslations[key];
                    }
                }
            });
            
            // Update document title
            if (currentTranslations['system.title']) {
                document.title = currentTranslations['system.title'] + ' - ' + 
                                 (currentTranslations['shift.b'] || 'Shift B');
            }
        } catch (error) {
            console.error('❌ Error updating page language:', error);
        }
    }
    
    // Regenerate all data sets with current language
    function regenerateAllDataSets() {
        const container = document.getElementById('dataContainer');
        if (!container) {
            console.warn('⚠️ Data container not found');
            return;
        }
        
        try {
            // Save current form values before regenerating
            const currentData = [];
            for (let i = 1; i <= dataSetCount; i++) {
                const setData = {};
                // Query ALL input fields for this set number
                const allInputs = container.querySelectorAll(`input[name*="_${i}"], select[name*="_${i}"]`);
                allInputs.forEach(input => {
                    if (input.name) {
                        setData[input.name] = input.value;
                    }
                });
                currentData.push(setData);
            }
            
            // Force clear container completely
            while (container.firstChild) {
                container.removeChild(container.firstChild);
            }
            
            // Small delay to ensure DOM is fully cleared
            setTimeout(() => {
                try {
                    // Regenerate all sets with NEW language
                    for (let i = 1; i <= dataSetCount; i++) {
                        const wrapper = document.createElement('div');
                        wrapper.innerHTML = generateDataSet(i);
                        const child = wrapper.firstElementChild;
                        if (child) container.appendChild(child);
                    }
                    
                    // Restore form values after DOM is ready
                    setTimeout(() => {
                        currentData.forEach((setData, index) => {
                            Object.keys(setData).forEach(name => {
                                const input = container.querySelector(`[name="${name}"]`);
                                if (input && setData[name]) {
                                    input.value = setData[name];
                                }
                            });
                        });
                        
                        // Re-initialize handlers
                        setupSelectHandlers();
                        refreshAllSelects();
                        try { 
                            if (window.PD2_WAGE_B) {
                                window.PD2_WAGE_B.bindWageBForAllSets();
                            }
                        } catch(e) {
                            console.warn('⚠️ Wage calculator not available:', e.message);
                        }
                        
                        console.log('✅ Data sets regenerated with language:', currentLang);
                    }, 10);
                } catch (innerError) {
                    console.error('❌ Error in regeneration loop:', innerError);
                }
            }, 10);
            
        } catch (error) {
            console.error('❌ Error regenerating data sets:', error);
            // Don't throw - keep existing data if regeneration fails
        }
    }
    
    // Initialize language on page load
    document.addEventListener('DOMContentLoaded', function() {
        try {
            // Check if translations loaded
            if (typeof translations === 'undefined') {
                console.error('❌ Translations script not loaded!');
                return;
            }
            
            // Set initial language display
            const langDisplay = document.getElementById('currentLanguage');
            if (langDisplay) {
                langDisplay.textContent = languageNames[currentLang];
            }
            
            // Apply saved language (don't regenerate for Thai - it's default)
            if (currentLang !== 'th') {
                setTimeout(() => {
                    updatePageLanguage();
                    regenerateAllDataSets();
                }, 100); // Small delay to ensure DOM is ready
            }
        } catch (error) {
            console.error('❌ Error initializing language:', error);
        }
    });
</script>
</body>
</html>
